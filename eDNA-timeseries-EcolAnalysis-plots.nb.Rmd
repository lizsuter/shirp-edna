---
title: "ShiRP eDNA Time Series- Mifish Elas02 CO1 plots"
output: html_notebook
---


Notebook for making plots from eDNA data (trawl and manual samples only- not expedition)

Import data tables generated with [/MiFish-Elas-CO1-handsamples-2020-2025.nb.html](MiFish-Elas-CO1-handsamples-2020-2025 notebook)

# Load packages

```{r}
# rm(list = ls())
library(tidyverse)
library(phyloseq)
library(vegan)
library(RColorBrewer)
library(microbiome)
library(metagMisc)
library(fantaxtic)
library(ggrepel)
library(paletteer)
library(pals)
library(compositions)
library(hms)
library(ggvegan)
```

# Global vars
update years and output directory for figures, as needed
```{r}
mifish_years <- 2020:2025
elas_years <- c(2021, 2023, 2024, 2025)
co1_years <- c(2024, 2025)

data_dir <-  "filtered_data"
out_dir <- "figures-timeseries"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
```


#  Import cleand up data tables
## Mifish
Function that imports cleaned up data tables and turns into phyloseq object for all mifish data, any year:
```{r}
read_matrix_first_col_as_rownames <- function(path) {
  df <- read.csv(path, header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)

  # Use first column as rownames (whatever its name is)
  rn <- df[[1]]
  df <- df[, -1, drop = FALSE]
  rownames(df) <- rn

  as.matrix(df)
}

read_sampledata_first_col_as_rownames <- function(path) {
  df <- read.csv(path, header = TRUE, stringsAsFactors = TRUE, check.names = FALSE)

  rn <- df[[1]]
  df <- df[, -1, drop = FALSE]
  rownames(df) <- rn

  df
}

make_phyloseq_mifish <- function(year, data_dir = "filtered_data") {

  asv_path  <- file.path(data_dir, sprintf("mifish_%d_glommed_asv_table.csv", year))
  tax_path  <- file.path(data_dir, sprintf("mifish_%d_glommed_tax_table.csv", year))
  samp_path <- file.path(data_dir, sprintf("mifish_%d_sample_data.csv", year))

  asv_mat <- read_matrix_first_col_as_rownames(asv_path)

  # Tax table is different: rownames column might not be first; handle by name if present
  tax_df <- read.csv(tax_path, header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)
  if ("X1stRepresentative_ASV" %in% names(tax_df)) {
    rownames(tax_df) <- tax_df$X1stRepresentative_ASV
    tax_df <- tax_df[, setdiff(names(tax_df), "X1stRepresentative_ASV"), drop = FALSE]
  } else {
    # fallback: assume first column contains rownames
    rn <- tax_df[[1]]
    tax_df <- tax_df[, -1, drop = FALSE]
    rownames(tax_df) <- rn
  }
  tax_mat <- as.matrix(tax_df)

  samp_df <- read_sampledata_first_col_as_rownames(samp_path)

  phyloseq(
    otu_table(asv_mat, taxa_are_rows = TRUE),
    tax_table(tax_mat),
    sample_data(samp_df)
  )
}

```

Run
```{r}
phylo_mifish <- setNames(lapply(mifish_years, make_phyloseq_mifish), as.character(mifish_years))
```



## Elas02
Function
```{r}
make_phyloseq_elas <- function(year, data_dir = "filtered_data") {

  asv_path  <- file.path(data_dir, sprintf("elas_%d_glommed_asv_table.csv", year))
  tax_path  <- file.path(data_dir, sprintf("elas_%d_glommed_tax_table.csv", year))
  samp_path <- file.path(data_dir, sprintf("elas_%d_sample_data.csv", year))

  # ASV table: first column = rownames (robust to X / ...1 / blank header)
  asv_mat <- read_matrix_first_col_as_rownames(asv_path)

  # Tax table: prefer REVAMP-style column name, otherwise fall back to first column
  tax_df <- read.csv(tax_path, header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)
  if ("X1stRepresentative_ASV" %in% names(tax_df)) {
    rownames(tax_df) <- tax_df$X1stRepresentative_ASV
    tax_df <- tax_df[, setdiff(names(tax_df), "X1stRepresentative_ASV"), drop = FALSE]
  } else {
    rn <- tax_df[[1]]
    tax_df <- tax_df[, -1, drop = FALSE]
    rownames(tax_df) <- rn
  }
  tax_mat <- as.matrix(tax_df)

  # Sample metadata: first column = rownames (robust)
  samp_df <- read_sampledata_first_col_as_rownames(samp_path)

  phyloseq(
    otu_table(asv_mat, taxa_are_rows = TRUE),
    tax_table(tax_mat),
    sample_data(samp_df)
  )
}

```

Run
```{r}

phylo_elas <- setNames(
  lapply(elas_years, make_phyloseq_elas),
  as.character(elas_years)
)
```

## CO1
Keep in mind this is filtered to only those species expected to be caughy by trawl (eg. pelagic/ swimming species plus all fish. removed many planktonic and benthic invertebrates)
```{r}
make_phyloseq_co1 <- function(year, data_dir = "filtered_data") {

  asv_path  <- file.path(data_dir, sprintf("co1_%d_glommed_asv_table_fortrawlcomparisononly.csv", year))
  tax_path  <- file.path(data_dir, sprintf("co1_%d_glommed_tax_table_fortrawlcomparisononly.csv", year))
  samp_path <- file.path(data_dir, sprintf("co1_%d_sample_data_fortrawlcomparisononly.csv", year))

  # ASV table (robust to X / ...1 / blank header)
  asv_mat <- read_matrix_first_col_as_rownames(asv_path)

  # Tax table (prefer REVAMP column name; otherwise fall back to first col)
  tax_df <- read.csv(tax_path, header = TRUE, stringsAsFactors = FALSE, check.names = FALSE)
  if ("X1stRepresentative_ASV" %in% names(tax_df)) {
    rownames(tax_df) <- tax_df$X1stRepresentative_ASV
    tax_df <- tax_df[, setdiff(names(tax_df), "X1stRepresentative_ASV"), drop = FALSE]
  } else {
    rn <- tax_df[[1]]
    tax_df <- tax_df[, -1, drop = FALSE]
    rownames(tax_df) <- rn
  }
  tax_mat <- as.matrix(tax_df)

  # Sample metadata (robust)
  samp_df <- read_sampledata_first_col_as_rownames(samp_path)

  phyloseq(
    otu_table(asv_mat, taxa_are_rows = TRUE),
    tax_table(tax_mat),
    sample_data(samp_df)
  )
}

```

Run
```{r}
phylo_co1 <- setNames(
  lapply(co1_years, make_phyloseq_co1),
  as.character(co1_years)
)
```


## Common names
Import common names database to set consistent color scheme
```{r}
commonnames <- read_csv(file = "../eDNA-databases/commonnames.csv")

myColors_sciname <- setNames(commonnames$Color, commonnames$Taxon)
myColors_comname <- setNames(commonnames$Color, commonnames$CommonName)
myColors_Sci_comname <- setNames(commonnames$Color, commonnames$Taxon.CommonName)


head(myColors_sciname)
head(myColors_comname)
head(myColors_Sci_comname)
```

# Plot positive controls

Function to pull out pos control samples
```{r}
make_posctl_objects <- function(ps, control_col = "controls", control_value = "positive") {

  out <- tryCatch({

    md <- as.data.frame(sample_data(ps))
    if (!control_col %in% colnames(md)) return(NULL)

    ctrl_vec <- trimws(tolower(as.character(md[[control_col]])))
    keep_ids <- rownames(md)[ctrl_vec == tolower(control_value)]
    if (length(keep_ids) == 0) return(NULL)

    ps_pos <- prune_samples(keep_ids, ps)
    if (nsamples(ps_pos) == 0) return(NULL)

    # trim taxa absent from all positive controls
    ps_pos <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
      ps_pos, minabund = 0, relabund = FALSE
    )

    if (nsamples(ps_pos) == 0 || ntaxa(ps_pos) == 0) return(NULL)

    ps_pos_ra <- microbiome::transform(ps_pos, transform = "compositional")

    list(ps_pos = ps_pos, ps_pos_ra = ps_pos_ra)

  }, error = function(e) {
    # if phyloseq/metagMisc throws errors, skip
    message("Skipping year due to error: ", conditionMessage(e))
    return(NULL)
  })

  out
}


```


Function to plot pos control plots
```{r}
make_posctl_barplot <- function(ps_obj, ylab_txt, colors) {
  plot_bar(ps_obj, fill = "Taxon.CommonName", x = "replicates") +
    scale_y_continuous(name = ylab_txt) +
    theme_minimal() +
    scale_fill_manual(values = colors) +
    guides(fill = guide_legend(nrow = 7, byrow = TRUE)) +
    theme(
      legend.position   = "bottom",
      legend.title      = element_blank(),
      legend.text       = element_text(size = 6, lineheight = 0.7),
      legend.key.size   = unit(0.35, "cm"),
      legend.spacing.x  = unit(0.15, "cm"),
      legend.spacing.y  = unit(0.15, "cm"),
      axis.text.x = element_text(size = 11, angle = 90, vjust = 0.5, hjust = 0),
      axis.text.y = element_text(size = 10)
    ) +
    scale_x_discrete(labels = function(x) gsub("positive", "", x, ignore.case = TRUE)) +
    labs(x = NULL, y = ylab_txt, title = NULL)
}

```

## MiFish
Run function
```{r}
mifish_posctl <- setNames(vector("list", length(mifish_years)), as.character(mifish_years))

for (yr in mifish_years) {
  ps <- phylo_mifish[[as.character(yr)]]
  if (is.null(ps)) next

  mifish_posctl[[as.character(yr)]] <- make_posctl_objects(ps)
}

```

Plot and save
```{r}
mifish_posctl_plots <- list()

for (yr_chr in names(mifish_posctl)) {
  ps_pos    <- mifish_posctl[[yr_chr]]$ps_pos
  ps_pos_ra <- mifish_posctl[[yr_chr]]$ps_pos_ra

  if (is.null(ps_pos) || is.null(ps_pos_ra) || nsamples(ps_pos) == 0) next

  yr <- as.integer(yr_chr)

  p_reads <- make_posctl_barplot(ps_pos, "Read Abundance", myColors_Sci_comname)
  p_ra    <- make_posctl_barplot(ps_pos_ra, "Relative Abundance", myColors_Sci_comname)


  mifish_posctl_plots[[yr_chr]] <- list(reads = p_reads, ra = p_ra)

  ggsave(plot = p_reads,
         filename = file.path(out_dir, sprintf("mifish_posctl_barplot_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)

  ggsave(plot = p_ra,
         filename = file.path(out_dir, sprintf("mifish_posctl_barplot_ra_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)
}

```


## Elas
Run
Not every year has elasmo pos ctls, so skip those that don't exist
```{r}
elas_posctl <- list()

for (yr in elas_years) {
  ps <- phylo_elas[[as.character(yr)]]
  if (is.null(ps)) next

  obj <- make_posctl_objects(ps)

  if (is.null(obj)) {
    message("Skipping ", yr, " (no positive controls or no taxa detected)")
    next
  }

  elas_posctl[[as.character(yr)]] <- obj
}


```


Plot and save
```{r}
elas_posctl_plots <- list()

for (yr_chr in names(elas_posctl)) {
  ps_pos    <- elas_posctl[[yr_chr]]$ps_pos
  ps_pos_ra <- elas_posctl[[yr_chr]]$ps_pos_ra

  if (is.null(ps_pos) || is.null(ps_pos_ra) || nsamples(ps_pos) == 0) next

  yr <- as.integer(yr_chr)

  p_reads <- make_posctl_barplot(ps_pos, "Read Abundance", myColors_Sci_comname)
  p_ra    <- make_posctl_barplot(ps_pos_ra, "Relative Abundance", myColors_Sci_comname)


  elas_posctl_plots[[yr_chr]] <- list(reads = p_reads, ra = p_ra)

  ggsave(plot = p_reads,
         filename = file.path(out_dir, sprintf("elas_posctl_barplot_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)

  ggsave(plot = p_ra,
         filename = file.path(out_dir, sprintf("elas_posctl_barplot_ra_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)
}


```




## CO1
Run 
```{r}
co1_posctl <- setNames(vector("list", length(co1_years)), as.character(co1_years))

for (yr in co1_years) {
  ps <- phylo_co1[[as.character(yr)]]
  if (is.null(ps)) next

  co1_posctl[[as.character(yr)]] <- make_posctl_objects(ps)
}
```


Plot and save
```{r}
co1_posctl_plots <- list()

for (yr_chr in names(co1_posctl)) {
  ps_pos    <- co1_posctl[[yr_chr]]$ps_pos
  ps_pos_ra <- co1_posctl[[yr_chr]]$ps_pos_ra

  if (is.null(ps_pos) || is.null(ps_pos_ra) || nsamples(ps_pos) == 0) next

  yr <- as.integer(yr_chr)

  p_reads <- make_posctl_barplot(ps_pos, "Read Abundance", myColors_Sci_comname)
  p_ra    <- make_posctl_barplot(ps_pos_ra, "Relative Abundance", myColors_Sci_comname)

  co1_posctl_plots[[yr_chr]] <- list(reads = p_reads, ra = p_ra)

  ggsave(plot = p_reads,
         filename = file.path(out_dir, sprintf("co1_posctl_barplot_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)

  ggsave(plot = p_ra,
         filename = file.path(out_dir, sprintf("co1_posctl_barplot_ra_%d.jpg", yr)),
         width = 7, height = 4, units = "in", dpi = 300)
}

```



# Plot Samples
## Prepare functions
Function to remove controls, sort by station number in sites, order Bayside by West/ East (instead of alphabetically East/West), and order the months in a sensible order, and convert to dataframe
```{r}
prep_psmelt_raw_and_ra <- function(ps,
                                  tax_rank   = "Taxon.CommonName",
                                  control_col = "controls",
                                  site_col    = "sites",
                                  bayside_col = "Bayside",
                                  month_col   = "Month") {

  # --- helpers ---
  make_site_levels <- function(x) {
    x_chr <- as.character(x)
    x_num <- suppressWarnings(as.numeric(x_chr))
    if (all(is.na(x_num))) {
      # fallback: character sort
      sort(unique(x_chr))
    } else {
      # numeric sort, keep original string labels (e.g., "01", "1")
      x_chr[order(x_num)][!duplicated(x_num[order(x_num)])] |> unique()
    }
  }

  make_month_levels <- function(x) {
    x_chr <- as.character(x)

    # numeric months (1-12, "01"-"12")
    x_num <- suppressWarnings(as.integer(x_chr))
    if (!all(is.na(x_num))) {
      lev <- sort(unique(x_num))
      return(as.character(lev))
    }

    # month names
    month_full  <- tolower(month.name)   # january..december
    month_abbr  <- tolower(month.abb)    # jan..dec
    x_low <- tolower(x_chr)

    if (all(x_low %in% month_full)) {
      return(month.name[match(sort(unique(x_low), index.return = TRUE)$x, month_full)])
    }
    if (all(x_low %in% month_abbr)) {
      return(month.abb[match(sort(unique(x_low), index.return = TRUE)$x, month_abbr)])
    }

    # fallback: leave in sorted unique order
    sort(unique(x_chr))
  }

  apply_ordering <- function(df) {
    # sites factor + ordering
    if (site_col %in% names(df)) {
      site_levels <- make_site_levels(df[[site_col]])
      df <- df %>%
        mutate(
          sites_f = factor(as.character(.data[[site_col]]), levels = site_levels)
        ) %>%
        arrange(sites_f)
    }

    # Bayside WEST/EAST factor (handle E/W too)
  if (bayside_col %in% names(df)) {
    df <- df %>%
      mutate(
        Bayside_std = case_when(
          toupper(as.character(.data[[bayside_col]])) %in% c("W", "WEST") ~ "WEST",
          toupper(as.character(.data[[bayside_col]])) %in% c("E", "EAST") ~ "EAST",
          TRUE ~ NA_character_
        ),
        Bayside_f = factor(Bayside_std, levels = c("WEST", "EAST"))
      )
  }


    # Month factor in sensible order
    if (month_col %in% names(df)) {
      month_levels <- make_month_levels(df[[month_col]])
      df <- df %>%
        mutate(
          Month_f = factor(as.character(.data[[month_col]]), levels = month_levels)
        )
    }

    df
  }

  # --- remove controls (keep only NA) ---
  md <- as.data.frame(sample_data(ps))
  has_controls <- control_col %in% names(md)

  ps_raw <- ps
  if (has_controls) {
    keep_ids <- rownames(md)[is.na(md[[control_col]])]
    ps_raw <- prune_samples(keep_ids, ps_raw)
  }

  # --- melt raw ---
  df_raw <- psmelt(ps_raw)
  df_raw[df_raw == 0] <- NA
  df_raw <- df_raw %>% filter(!is.na(Abundance))
  df_raw <- apply_ordering(df_raw)

  # --- rel abun (tax_glom + compositional) ---
  if (!tax_rank %in% rank_names(ps)) {
    stop(
      "Tax rank '", tax_rank, "' not found in tax_table(ps). Available: ",
      paste(rank_names(ps), collapse = ", ")
    )
  }

  ps_ra <- tax_glom(ps, taxrank = tax_rank)

  if (has_controls) {
    md2 <- as.data.frame(sample_data(ps_ra))
    keep_ids2 <- rownames(md2)[is.na(md2[[control_col]])]
    ps_ra <- prune_samples(keep_ids2, ps_ra)
  }

  ps_ra <- microbiome::transform(ps_ra, transform = "compositional")

  df_ra <- psmelt(ps_ra)
  df_ra[df_ra == 0] <- NA
  df_ra <- df_ra %>% filter(!is.na(Abundance))
  df_ra <- apply_ordering(df_ra)

  list(
    ps_raw = ps_raw,
    df_raw = df_raw,
    ps_ra  = ps_ra,
    df_ra  = df_ra
  )
}

```

Run
```{r}
mifish_sample_dfs <- lapply(phylo_mifish, prep_psmelt_raw_and_ra)
elas_sample_dfs <- lapply(phylo_elas, prep_psmelt_raw_and_ra)
co1_sample_dfs <- lapply(phylo_co1, prep_psmelt_raw_and_ra)
```


Clean up tables a bit
- check site levels are ordered
- average replicates
- remove pos ctl organisms from 2025 data (guinea pig, python)

```{r}
# remove positive-control organisms (taxa) everywhere
posctl_patterns <- c(
  "Cavia",
  "Python"
  # add more strings here as needed (case-insensitive partial match)
)

drop_posctl_taxa_ps <- function(ps, patterns = posctl_patterns,
                                cols = c("Taxon.CommonName", "Species", "CommonName")) {
  tt <- as.data.frame(tax_table(ps))

  cols <- intersect(cols, colnames(tt))
  if (length(cols) == 0) return(ps)

  hit <- Reduce(
    `|`,
    lapply(patterns, function(p) {
      Reduce(`|`, lapply(cols, function(cc) grepl(p, tt[[cc]], ignore.case = TRUE)))
    })
  )

  prune_taxa(!hit, ps)
}

drop_posctl_taxa_df <- function(df, patterns = posctl_patterns,
                                cols = c("Taxon.CommonName", "Species", "CommonName")) {
  cols <- intersect(cols, names(df))
  if (length(cols) == 0) return(df)

  hit <- Reduce(
    `|`,
    lapply(patterns, function(p) {
      Reduce(`|`, lapply(cols, function(cc) grepl(p, df[[cc]], ignore.case = TRUE)))
    })
  )

  dplyr::filter(df, !hit)
}

mifish_sample_dfs <- lapply(mifish_sample_dfs, \(x) { x$df_raw <- drop_posctl_taxa_df(x$df_raw); x$df_ra <- drop_posctl_taxa_df(x$df_ra); x })
elas_sample_dfs   <- lapply(elas_sample_dfs,   \(x) { x$df_raw <- drop_posctl_taxa_df(x$df_raw); x$df_ra <- drop_posctl_taxa_df(x$df_ra); x })
co1_sample_dfs    <- lapply(co1_sample_dfs,    \(x) { x$df_raw <- drop_posctl_taxa_df(x$df_raw); x$df_ra <- drop_posctl_taxa_df(x$df_ra); x })

# ensure sitelevels are in numeric order for x axis
get_sitelevels <- function(df, site_col = "sites") {
  if ("sites_f" %in% names(df)) {
    return(levels(df$sites_f))
  }

  x <- as.character(df[[site_col]])
  x_num <- suppressWarnings(as.numeric(x))

  if (all(is.na(x_num))) sort(unique(x)) else as.character(sort(unique(x_num)))
}

# average replicates
average_replicates <- function(df, facet_col) {
  grp_cols <- c("sites", facet_col, "CommonName", "Taxon.CommonName")
  grp_cols <- grp_cols[grp_cols %in% names(df)]

  df %>%
    group_by(across(all_of(grp_cols))) %>%
    summarize(Abundance = mean(Abundance), .groups = "drop")
}
```

Single bubble plot function
```{r}
# Make a bubble plot faceted by one variable
make_bubbleplot <- function(df,
                            facet_col,
                            colors,
                            title = NULL,
                            sitelevels = NULL,
                            size_breaks = c(1000, 10000, 100000, 1000000, 10000000),
                            facet_type = c("grid", "wrap"),
                            nrow_wrap = 1) {

  facet_type <- match.arg(facet_type)

  if (is.null(sitelevels)) sitelevels <- get_sitelevels(df)

  p <- ggplot(
    df,
    aes(x = factor(sites, levels = sitelevels),
        y = fct_rev(`Taxon.CommonName`))
  ) +
    geom_point(
      aes(size = ifelse(Abundance == 0, NA, Abundance),
          fill = `Taxon.CommonName`),
      color = "black", pch = 21
    ) +
    scale_size_area(breaks = size_breaks) +
    theme_bw() +
    scale_fill_manual(values = colors) +
    labs(x = "", y = "", size = "Read Abundance", fill = "", title = title) +
    theme(
      axis.title.x = element_blank(),
      axis.text.x  = element_text(size = 12),
      axis.text.y  = element_text(size = 10),
      legend.position = "bottom"
    ) +
    guides(fill = "none")

  if (facet_type == "grid") {
    p <- p + facet_grid(as.formula(paste0("~", facet_col)),
                        scales = "free", space = "free", drop = TRUE)
  } else {
    p <- p + facet_wrap(as.formula(paste0("~", facet_col)),
                        drop = TRUE, nrow = nrow_wrap)
  }

  p
}

```

Function to make all bubble plots for one year (by bayside, by month, by habitat and month, using above)
```{r}
make_bubbleplots_for_year <- function(df_raw,
                                      lib = "mifish",
                                      year = 2024,
                                      out_dir = "figures-timeseries",
                                      colors = myColors_Sci_comname,
                                      trawl_sites = 1:13,
                                      habitats_to_plot = c("EELGRASS", "CLAM SANCTUARY", "OYSTER REEF")) {

  dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

  # compute sitelevels
  sitelevels <- get_sitelevels(df_raw)

  plots <- list()

  # ---- 1) By Bayside ----
  if ("Bayside_f" %in% names(df_raw)) {
    df_bayside <- average_replicates(df_raw, facet_col = "Bayside_f")

    plots$bayside <- make_bubbleplot(
      df_bayside,
      facet_col = "Bayside_f",
      colors = colors,
      sitelevels = sitelevels,
      facet_type = "grid"
    )

    ggsave(
      plots$bayside,
      filename = file.path(out_dir, sprintf("bubbleplot_%s_Bayside_%d.jpg", lib, year)),
      width = 9, height = 8, units = "in", dpi = 300
    )
  }

  # ---- 2) By Month (all sites) ----
  if ("Month_f" %in% names(df_raw)) {
    df_month <- average_replicates(df_raw, facet_col = "Month_f")

    plots$month <- make_bubbleplot(
      df_month,
      facet_col = "Month_f",
      colors = colors,
      sitelevels = sitelevels,
      facet_type = "wrap",
      nrow_wrap = 1
    )

    ggsave(
      plots$month,
      filename = file.path(out_dir, sprintf("bubbleplot_%s_Month_%d.jpg", lib, year)),
      width = 22, height = 8, units = "in", dpi = 300
    )

    # ---- 3) By Month (trawl sites only) ----
    df_month_trawl <- df_raw %>%
      filter(sites %in% trawl_sites) %>%
      average_replicates(facet_col = "Month_f")

    plots$month_trawl <- make_bubbleplot(
      df_month_trawl,
      facet_col = "Month_f",
      colors = colors,
      sitelevels = sitelevels,
      facet_type = "wrap",
      nrow_wrap = 1
    )

    ggsave(
      plots$month_trawl,
      filename = file.path(out_dir, sprintf("bubbleplot_%s_Month_trawlonly_%d.jpg", lib, year)),
      width = 12, height = 8, units = "in", dpi = 300
    )

    # ---- 4) By Month within each habitat ----
    if ("Habitat" %in% names(df_raw)) {
      for (hab in habitats_to_plot) {
        df_hab <- df_raw %>%
          filter(Habitat == hab) %>%
          average_replicates(facet_col = "Month_f")

        # skip empty habitat-years
        if (nrow(df_hab) == 0) next

        plots[[paste0("month_hab_", gsub(" ", "", tolower(hab)))]] <- make_bubbleplot(
          df_hab,
          facet_col = "Month_f",
          colors = colors,
          sitelevels = sitelevels,
          facet_type = "grid"
        )

        ggsave(
          plots[[paste0("month_hab_", gsub(" ", "", tolower(hab)))]],
          filename = file.path(out_dir, sprintf("bubbleplot_%s_Month_%s_%d.jpg", lib, gsub(" ", "", tolower(hab)), year)),
          width = 9, height = 5, units = "in", dpi = 300
        )
      }
    }
  }

  plots
}

```


Run for all years and libraries
```{r}
bubbleplots_all <- list()

# MiFish
bubbleplots_all$mifish <- lapply(names(mifish_sample_dfs), function(yr_chr) {
  yr <- as.integer(yr_chr)
  df <- mifish_sample_dfs[[yr_chr]]$df_raw
  make_bubbleplots_for_year(df, lib = "mifish", year = yr, out_dir = out_dir, colors = myColors_Sci_comname)
})
names(bubbleplots_all$mifish) <- names(mifish_sample_dfs)

# Elas02
bubbleplots_all$elas <- lapply(names(elas_sample_dfs), function(yr_chr) {
  yr <- as.integer(yr_chr)
  df <- elas_sample_dfs[[yr_chr]]$df_raw
  make_bubbleplots_for_year(df, lib = "elas", year = yr, out_dir = out_dir, colors = myColors_Sci_comname)
})
names(bubbleplots_all$elas) <- names(elas_sample_dfs)

# CO1
bubbleplots_all$co1 <- lapply(names(co1_sample_dfs), function(yr_chr) {
  yr <- as.integer(yr_chr)
  df <- co1_sample_dfs[[yr_chr]]$df_raw
  make_bubbleplots_for_year(df, lib = "co1", year = yr, out_dir = out_dir, colors = myColors_Sci_comname)
})
names(bubbleplots_all$co1) <- names(co1_sample_dfs)

```


## 1/8/25 STOPPED HERE- ALL FILTERING LOOKS GOOD. CONTINUE BELOW























### MiFish- Species Time Series

#### Trawl sites

```{r}
# First average replicates from same month and across all trawl sites
mifish_df_month_trawls <- mifish_df %>%
  filter(site_altname %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13)) %>%
  group_by(Month_f, CommonName, `Taxon.CommonName`) %>%
  dplyr::summarize(MeanAbundance = mean(Abundance)) %>%
  mutate(Month_f = factor(Month_f, levels = 6:9, labels = c("Jun", "Jul", "Aug", "Sep"), ordered = TRUE))
mifish_df_month_trawls

# take only top species
top20_species <- mifish_df_month_trawls %>%
  group_by(`Taxon.CommonName`) %>%
  summarise(TotalAbundance = sum(MeanAbundance, na.rm = TRUE)) %>%
  arrange(desc(TotalAbundance)) %>%
  slice_head(n = 20) %>%
  pull(`Taxon.CommonName`)


mifish_df_month_top20 <- mifish_df_month_trawls %>%
  filter(`Taxon.CommonName` %in% top20_species) %>%
  ungroup() %>%  
  complete(
    Month_f,
    nesting(`Taxon.CommonName`, CommonName),
    fill = list(MeanAbundance = 0)
  ) %>%
  mutate(FacetLabel = str_wrap(`Taxon.CommonName`, width = 20))

timeseries_mifish_Month <- 
ggplot(mifish_df_month_top20) + 
  geom_area(aes(x = Month_f, y = MeanAbundance, fill = `Taxon.CommonName`, group = 1), alpha = 0.7) +
  facet_wrap(~FacetLabel, scales = "free_y") +
  xlab("") +
  scale_fill_manual(values = myColors_Sci_comname) +
  theme_minimal() +
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10),
        legend.position = "none") 

timeseries_mifish_Month
  
# save
ggsave(plot = timeseries_mifish_Month, filename = "figures-2024eDNA/mifish_topspecies_timeseries.jpg", width = 11, height = 8, units = "in")
```

#### Clam Sites
```{r}
# First average replicates from same month and across all trawl sites
mifish_df_month_clamsites <- mifish_df %>%
  filter(sites %in% c(23, 24)) %>%
  group_by(Month_f, CommonName, `Taxon.CommonName`) %>%
  dplyr::summarize(MeanAbundance = mean(Abundance)) %>%
  mutate(Month_f = factor(Month_f, levels = 6:9, labels = c("Jun", "Jul", "Aug", "Sep"), ordered = TRUE))
mifish_df_month_clamsites

# take only top species
top12_species <- mifish_df_month_clamsites %>%
  group_by(`Taxon.CommonName`) %>%
  summarise(TotalAbundance = sum(MeanAbundance, na.rm = TRUE)) %>%
  arrange(desc(TotalAbundance)) %>%
  slice_head(n = 12) %>%
  pull(`Taxon.CommonName`)


mifish_df_month_top12 <- mifish_df_month_clamsites %>%
  filter(`Taxon.CommonName` %in% top12_species) %>%
  ungroup() %>%  
  complete(
    Month_f,
    nesting(`Taxon.CommonName`, CommonName),
    fill = list(MeanAbundance = 0)
  ) %>%
  mutate(FacetLabel = str_wrap(`Taxon.CommonName`, width = 20))

timeseries_mifish_Month_clamsites <- 
ggplot(mifish_df_month_top12) + 
  geom_area(aes(x = Month_f, y = MeanAbundance, fill = `Taxon.CommonName`, group = 1), alpha = 0.7) +
  facet_wrap(~FacetLabel, scales = "free_y") +
  xlab("") +
  scale_fill_manual(values = myColors_Sci_comname) +
  theme_minimal() +
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10),
        legend.position = "none") 

timeseries_mifish_Month_clamsites
  
# save
ggsave(plot = timeseries_mifish_Month_clamsites, filename = "figures-2024eDNA/mifish_topspecies_timeseries_clamsites.jpg", width = 8.8, height = 6, units = "in")
```

#### Oyster Sites
```{r}
# First average replicates from same month and across all trawl sites
mifish_df_month_oystersites <- mifish_df %>%
  filter(sites %in% c(25, 26, 31, 32, 33, 34)) %>%
  group_by(Month_f, CommonName, `Taxon.CommonName`) %>%
  dplyr::summarize(MeanAbundance = mean(Abundance)) %>%
  mutate(Month_f = factor(Month_f, levels = 6:9, labels = c("Jun", "Jul", "Aug", "Sep"), ordered = TRUE))
mifish_df_month_oystersites

# take only top species
top12_species <- mifish_df_month_oystersites %>%
  group_by(`Taxon.CommonName`) %>%
  summarise(TotalAbundance = sum(MeanAbundance, na.rm = TRUE)) %>%
  arrange(desc(TotalAbundance)) %>%
  slice_head(n = 12) %>%
  pull(`Taxon.CommonName`)


mifish_df_month_top12 <- mifish_df_month_oystersites %>%
  filter(`Taxon.CommonName` %in% top12_species) %>%
  ungroup() %>%  
  complete(
    Month_f,
    nesting(`Taxon.CommonName`, CommonName),
    fill = list(MeanAbundance = 0)
  ) %>%
  mutate(FacetLabel = str_wrap(`Taxon.CommonName`, width = 20))

timeseries_mifish_Month_oystersites <- 
ggplot(mifish_df_month_top12) + 
  geom_area(aes(x = Month_f, y = MeanAbundance, fill = `Taxon.CommonName`, group = 1), alpha = 0.7) +
  facet_wrap(~FacetLabel, scales = "free_y") +
  xlab("") +
  scale_fill_manual(values = myColors_Sci_comname) +
  theme_minimal() +
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10),
        legend.position = "none") 

timeseries_mifish_Month_oystersites
  
# save
ggsave(plot = timeseries_mifish_Month_oystersites, filename = "figures-2024eDNA/mifish_topspecies_timeseries_oystersites.jpg", width = 8.8, height = 6, units = "in")
```

#### Eelgrass Sites
```{r}
# First average replicates from same month and across all trawl sites
mifish_df_month_eelgrasssites <- mifish_df %>%
  filter(sites %in% c(27, 28, 29, 30)) %>%
  group_by(Month_f, CommonName, `Taxon.CommonName`) %>%
  dplyr::summarize(MeanAbundance = mean(Abundance)) %>%
  mutate(Month_f = factor(Month_f, levels = 6:9, labels = c("Jun", "Jul", "Aug", "Sep"), ordered = TRUE))
mifish_df_month_eelgrasssites

# take only top species
top12_species <- mifish_df_month_eelgrasssites %>%
  group_by(`Taxon.CommonName`) %>%
  summarise(TotalAbundance = sum(MeanAbundance, na.rm = TRUE)) %>%
  arrange(desc(TotalAbundance)) %>%
  slice_head(n = 12) %>%
  pull(`Taxon.CommonName`)


mifish_df_month_top12 <- mifish_df_month_eelgrasssites %>%
  filter(`Taxon.CommonName` %in% top12_species) %>%
  ungroup() %>%  
  complete(
    Month_f,
    nesting(`Taxon.CommonName`, CommonName),
    fill = list(MeanAbundance = 0)
  ) %>%
  mutate(FacetLabel = str_wrap(`Taxon.CommonName`, width = 20))

timeseries_mifish_Month_eelgrasssites <- 
ggplot(mifish_df_month_top12) + 
  geom_area(aes(x = Month_f, y = MeanAbundance, fill = `Taxon.CommonName`, group = 1), alpha = 0.7) +
  facet_wrap(~FacetLabel, scales = "free_y") +
  xlab("") +
  scale_fill_manual(values = myColors_Sci_comname) +
  theme_minimal() +
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10),
        legend.position = "none") 

timeseries_mifish_Month_eelgrasssites
  
# save
ggsave(plot = timeseries_mifish_Month_eelgrasssites, filename = "figures-2024eDNA/mifish_topspecies_timeseries_eelgrasssites.jpg", width = 8.8, height = 6, units = "in")
```

### Elas02 Bubble Plots
#### By bayside
```{r}
# First average replicates at same sites
elas_df_bayside <- elas_df %>%
    group_by(sites, Bayside_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_bayside


bubbleplot_elas_Bayside <- ggplot(elas_df_bayside, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 9), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_grid(~Bayside_f, scales = "free", space = "free", drop= TRUE)
bubbleplot_elas_Bayside
  
# save
ggsave(plot = bubbleplot_elas_Bayside, filename = "figures-2024eDNA/bubbleplot_elas_Bayside.jpg", width = 10, height = 3, units = "in")
```


#### By month
```{r}
# First average replicates from same month
elas_df_month <- elas_df %>%
    group_by(sites, Month_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_month


bubbleplot_elas_Month <- ggplot(elas_df_month, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_wrap(~Month_f, drop= TRUE, nrow = 1)  
bubbleplot_elas_Month
  
# save
ggsave(plot = bubbleplot_elas_Month, filename = "figures-2024eDNA/bubbleplot_elas_Month.jpg", width = 22, height = 3, units = "in")
```

#### By month, trawl sites only

```{r}
# First average replicates from same month
elas_df_month_trawl <- elas_df %>%
  filter(sites %in% c(1,2,3,4,5,6,7,8,9,10,11,12,13)) %>%
    group_by(sites, Month_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_month_trawl


bubbleplot_elas_Month_trawlonly <- ggplot(elas_df_month_trawl, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(), 
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_wrap(~Month_f, drop= TRUE, nrow = 1)  
bubbleplot_elas_Month_trawlonly
  
# save
ggsave(plot = bubbleplot_elas_Month_trawlonly, filename = "figures-2024eDNA/bubbleplot_elas_Month_trawlonly.jpg", width = 11, height = 2.5, units = "in")
```



#### By month, other sites

First checked labels and "SEA GRASS" AND "EEL GRASS" should be the same. Fix
```{r}
#check before
unique(elas_df$Habitat)

elas_df <- elas_df %>%
  mutate(Habitat = case_when(
    Habitat == "SEAGRASS" ~ "EELGRASS",
    TRUE ~ Habitat  # Keep all other values unchanged
  ))

#and after
unique(elas_df$Habitat)
```

Plot by othet habitat types:
Eelgrass
```{r}
# First average replicates from same month
elas_df_month_eelgrass <- elas_df %>%
  filter(Habitat == "EELGRASS") %>%
    group_by(sites, Month_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_month_eelgrass


bubbleplot_elas_Month_eelgrass <- ggplot(elas_df_month_eelgrass, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_grid(~Month_f, drop = TRUE, scales = "free", space = "free")
bubbleplot_elas_Month_eelgrass

# save
ggsave(plot = bubbleplot_elas_Month_eelgrass, filename = "figures-2024eDNA/bubbleplot_elas_Month_eelgrass.jpg", width = 9, height = 2.5, units = "in")
```


Clam Sanctuary
```{r}
# First average replicates from same month
elas_df_month_clamsanct <- elas_df %>%
  filter(Habitat == "CLAM SANCTUARY") %>%
    group_by(sites, Month_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_month_clamsanct


bubbleplot_elas_Month_clamsanct <- ggplot(elas_df_month_clamsanct, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_grid(~Month_f, drop = TRUE, scales = "free", space = "free")
bubbleplot_elas_Month_clamsanct

# save
ggsave(plot = bubbleplot_elas_Month_clamsanct, filename = "figures-2024eDNA/bubbleplot_elas_Month_clamsanct.jpg", width = 7, height = 2.5, units = "in")
```


Oyster reef
```{r}
# First average replicates from same month
elas_df_month_oysterreef <- elas_df %>%
  filter(Habitat == "OYSTER REEF") %>%
    group_by(sites, Month_f, CommonName, `Taxon.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
elas_df_month_oysterreef


bubbleplot_elas_Month_oysterreef <- ggplot(elas_df_month_oysterreef, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Taxon.CommonName`))) + 
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `Taxon.CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_Sci_comname)+
  theme(axis.title.x=element_blank(),
        axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 10), 
        legend.position = "bottom") +
  guides(fill="none") +
  facet_grid(~Month_f, drop = TRUE, scales = "free", space = "free")
bubbleplot_elas_Month_oysterreef

# save
ggsave(plot = bubbleplot_elas_Month_oysterreef, filename = "figures-2024eDNA/bubbleplot_elas_Month_oysterreef.jpg", width = 9, height = 3, units = "in")
```



### Elas- Species Time Series - TBD

### Diversity

Species richness by month and habitat types
- In June, eel grass stations were not sampled but all other habitat types were. So any zeroes in June are real for all habitat types except eel grass---
```{r}
# First: define all months and habitats you'd expect
all_months <- unique(c(mifish_df$Month, elas_df$Month))
all_habitats <- unique(c(mifish_df$Habitat, elas_df$Habitat))

# MiFish
species_counts_2024_mifish <- mifish_df %>%
  group_by(Habitat, Month) %>%
  summarise(UniqueSpeciesCount = n_distinct(`Taxon.CommonName`), .groups = "drop") %>%
  complete(Habitat = all_habitats, Month = all_months, fill = list(UniqueSpeciesCount = 0)) %>%
  filter(!(Habitat == "EELGRASS" & Month == "6"))


# Elas
species_counts_2024_elas <- elas_df %>%
  group_by(Habitat, Month) %>%
  summarise(UniqueSpeciesCount = n_distinct(`Taxon.CommonName`), .groups = "drop") %>%
  complete(Habitat = all_habitats, Month = all_months, fill = list(UniqueSpeciesCount = 0)) %>%
  filter(!(Habitat == "EELGRASS" & Month == "6"))

species_counts_2024_mifish
species_counts_2024_elas

```

#### Mifish
```{r}

sp_richnesss_habitat_month_mifish_plot <- ggplot(species_counts_2024_mifish, aes(x = Month, y = UniqueSpeciesCount, group = Habitat, color = Habitat)) +
  geom_line(size = 1, alpha = 0.8) +
  geom_point(size = 2, alpha = 0.8) +
  labs(x = "Month", y = "Species Richness", title = "2024 Species Richness; MiFish") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.title = element_blank()
  ) +
  scale_color_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"))

sp_richnesss_habitat_month_mifish_plot

# save
ggsave(plot = sp_richnesss_habitat_month_mifish_plot, filename = "figures-2024eDNA/sp_richnesss_habitat_month_mifish_plot.jpg", width = 5, height = 3, units = "in")


```



#### Elas02
```{r}
sp_richnesss_habitat_month_elas_plot <- ggplot(species_counts_2024_elas, aes(x = Month, y = UniqueSpeciesCount, group = Habitat, color = Habitat)) +
  geom_line(size = 1, alpha = 0.8) +
  geom_point(size = 2, alpha = 0.8) +
  labs(x = "Month", y = "Species Richness", title = "2024 Species Richness; Elas02") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.title = element_blank()
  ) +
  scale_color_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"))

sp_richnesss_habitat_month_elas_plot

# save
ggsave(plot = sp_richnesss_habitat_month_elas_plot, filename = "figures-2024eDNA/sp_richnesss_habitat_month_elas_plot.jpg", width = 5, height = 3, units = "in")


```






