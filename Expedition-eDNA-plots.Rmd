---
title: "Expedition eDNA Plots and Stats Analysis"
output: html_notebook
---
 

<br/>
<br/>

 

# Load packages

```{r}
# rm(list = ls())
library(tidyverse)
library(phyloseq)
library(vegan)
library(RColorBrewer)
library(microbiome)
library(metagMisc)
library(fantaxtic)
library(ggrepel)
library(paletteer)
library(pals)
library(compositions)
library(hms)
library(ggvegan)
```

#  Import and prepare data

Import-
I am creating the equivalent of "phylo1" from REVAMP, the dataset is the ASV-based, raw reads, not qual filtered dataset; "qual filtered" means the unknown ASVs have been removed, & low effort samples removed. The only filtering that has been done is the unknown ASVs have been removed.

Side note- I checked some of the high abundance unknowns that were thrown out (ASV_4 from 2021 and ASV_2 and _3 from 2023) and they are diatoms. They are coming up as unknown bc they are not in my Elas02 database. 

## 2024 Expedition data**
### Mifish-
```{r}
asv_count_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh-expedition/ASV2Taxonomy/ASVs_counts_NOUNKNOWNS.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_mifish) <- asv_count_mifish$x
asv_count_mifish <- asv_count_mifish %>% select(-x)
asv_count_mifish_mat <- as.matrix(asv_count_mifish)

asv_taxonomy_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh-expedition/ASV2Taxonomy/results-revamp-2024-MiFish-expedition_asvTaxonomyTable_NOUNKNOWNS.txt", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_taxonomy_mifish) <- asv_taxonomy_mifish$ASV
asv_taxonomy_mifish <- asv_taxonomy_mifish %>% select(-ASV)
asv_taxonomy_mifish_mat <- as.matrix(asv_taxonomy_mifish)



sample_metadata_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh-expedition/sample_metadata_forR.txt", header=TRUE, stringsAsFactors=TRUE)

# also import and join CTD values averaged over each eDNA sampling interval
sample_metadata2 <- read.csv("/Volumes/easystore/eDNA/shirp-edna/figures-expedition/CTD_avg_eDNA_sample_intervals.csv")

sample_metadata_mifish <- left_join(sample_metadata_mifish, sample_metadata2, by = c("Name.Deploy_Cartr_Library" = "Deploy_Cartr_Library"))

row.names(sample_metadata_mifish) <- sample_metadata_mifish$Sample
sample_metadata_mifish <- sample_metadata_mifish %>% select(-Sample)

ASV_2024_exp_mifish = otu_table(asv_count_mifish_mat, taxa_are_rows = TRUE)
TAX_2024_exp_mifish = tax_table(asv_taxonomy_mifish_mat)
samples_2024_exp_mifish = sample_data(sample_metadata_mifish)

phylo_2024_exp_mifish <- phyloseq(ASV_2024_exp_mifish, TAX_2024_exp_mifish, samples_2024_exp_mifish)


```

### Elas02-
```{r}
asv_count_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02-expedition/ASV2Taxonomy/ASVs_counts_NOUNKNOWNS.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_elas) <- asv_count_elas$x
asv_count_elas <- asv_count_elas %>% select(-x)
asv_count_elas_mat <- as.matrix(asv_count_elas)

asv_taxonomy_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02-expedition/ASV2Taxonomy/results-revamp-2024-Elas02-expedition_asvTaxonomyTable_NOUNKNOWNS.txt", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_taxonomy_elas) <- asv_taxonomy_elas$ASV
asv_taxonomy_elas <- asv_taxonomy_elas %>% select(-ASV)
asv_taxonomy_elas_mat <- as.matrix(asv_taxonomy_elas)

sample_metadata_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02-expedition/sample_metadata_forR.txt", header=TRUE, stringsAsFactors=TRUE)

sample_metadata_elas <- left_join(sample_metadata_elas, sample_metadata2, by = c("Name.Deploy_Cartr" = "Name.Deploy_Cartr"))

row.names(sample_metadata_elas) <- sample_metadata_elas$Sample
sample_metadata_elas <- sample_metadata_elas %>% select(-Sample)

ASV_2024_exp_elas = otu_table(asv_count_elas_mat, taxa_are_rows = TRUE)
TAX_2024_exp_elas = tax_table(asv_taxonomy_elas_mat)
samples_2024_exp_elas = sample_data(sample_metadata_elas)

phylo_2024_exp_elas <- phyloseq(ASV_2024_exp_elas, TAX_2024_exp_elas, samples_2024_exp_elas)


```


## 2024 Trawl data**
### Mifish-
```{r}
asv_count_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh/ASV2Taxonomy/ASVs_counts_NOUNKNOWNS.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_mifish) <- asv_count_mifish$x
asv_count_mifish <- asv_count_mifish %>% select(-x)
asv_count_mifish_mat <- as.matrix(asv_count_mifish)

asv_taxonomy_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh/ASV2Taxonomy/results-revamp-2024-MiFish_asvTaxonomyTable_NOUNKNOWNS.txt", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_taxonomy_mifish) <- asv_taxonomy_mifish$ASV
asv_taxonomy_mifish <- asv_taxonomy_mifish %>% select(-ASV)
asv_taxonomy_mifish_mat <- as.matrix(asv_taxonomy_mifish)

sample_metadata_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFIsh/sample_metadata_forR.txt", header=TRUE, stringsAsFactors=TRUE)
row.names(sample_metadata_mifish) <- sample_metadata_mifish$Sample
sample_metadata_mifish <- sample_metadata_mifish %>% select(-Sample)

ASV_2024_trawl_mifish = otu_table(asv_count_mifish_mat, taxa_are_rows = TRUE)
TAX_2024_trawl_mifish = tax_table(asv_taxonomy_mifish_mat)
samples_2024_trawl_mifish = sample_data(sample_metadata_mifish)

phylo_2024_trawl_mifish <- phyloseq(ASV_2024_trawl_mifish, TAX_2024_trawl_mifish, samples_2024_trawl_mifish)


```

### Elas02-
```{r}
asv_count_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02/ASV2Taxonomy/ASVs_counts_NOUNKNOWNS.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_elas) <- asv_count_elas$x
asv_count_elas <- asv_count_elas %>% select(-x)
asv_count_elas_mat <- as.matrix(asv_count_elas)

asv_taxonomy_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02/ASV2Taxonomy/results-revamp-2024-Elas02_asvTaxonomyTable_NOUNKNOWNS.txt", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_taxonomy_elas) <- asv_taxonomy_elas$ASV
asv_taxonomy_elas <- asv_taxonomy_elas %>% select(-ASV)
asv_taxonomy_elas_mat <- as.matrix(asv_taxonomy_elas)

sample_metadata_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02/sample_metadata_forR.txt", header=TRUE, stringsAsFactors=TRUE)
row.names(sample_metadata_elas) <- sample_metadata_elas$Sample
sample_metadata_elas <- sample_metadata_elas %>% select(-Sample)

ASV_2024_trawl_elas = otu_table(asv_count_elas_mat, taxa_are_rows = TRUE)
TAX_2024_trawl_elas = tax_table(asv_taxonomy_elas_mat)
samples_2024_trawl_elas = sample_data(sample_metadata_elas)

phylo_2024_trawl_elas <- phyloseq(ASV_2024_trawl_elas, TAX_2024_trawl_elas, samples_2024_trawl_elas)


```


For this analysis, I am only using the trawl results that coincide with the expedition (will do the rest of the season in another analysis).

Filter by date (expedition was 9/10-9/19/24)

```{r}
phylo_2024_trawl_mifish = subset_samples(phylo_2024_trawl_mifish, Datecode %in% c("20240910","20240916"))

phylo_2024_trawl_elas = subset_samples(phylo_2024_trawl_elas, Datecode %in% c("20240910","20240916"))
```


## Generate some metadata for manuscript
How many ASVs and reads were thrown out as unknowns?

### Expedition
#### Mifish-
```{r}
asv_count_unknowns_2024_exp_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFish-expedition/processed_tables/ASVs_counts_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_unknowns_2024_exp_mifish) <- asv_count_unknowns_2024_exp_mifish$x
asv_count_unknowns_2024_exp_mifish <- asv_count_unknowns_2024_exp_mifish %>% select(-x)

asv_count_nounknowns_2024_exp_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFish-expedition/processed_tables/ASVs_counts_NOUNKNOWNS_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_nounknowns_2024_exp_mifish) <- asv_count_nounknowns_2024_exp_mifish$x
asv_count_nounknowns_2024_exp_mifish <- asv_count_nounknowns_2024_exp_mifish %>% select(-x)
```

```{r}
# number of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_exp_mifish)

# fraction of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_exp_mifish)/count(asv_count_unknowns_2024_exp_mifish)

# number of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_exp_mifish))

# fraction of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_exp_mifish))/sum(rowSums(asv_count_unknowns_2024_exp_mifish))

```


#### Elas02-
```{r}
asv_count_unknowns_2024_exp_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02-expedition/processed_tables/ASVs_counts_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_unknowns_2024_exp_elas) <- asv_count_unknowns_2024_exp_elas$x
asv_count_unknowns_2024_exp_elas <- asv_count_unknowns_2024_exp_elas %>% select(-x)

asv_count_nounknowns_2024_exp_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02-expedition/processed_tables/ASVs_counts_NOUNKNOWNS_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_nounknowns_2024_exp_elas) <- asv_count_nounknowns_2024_exp_elas$x
asv_count_nounknowns_2024_exp_elas <- asv_count_nounknowns_2024_exp_elas %>% select(-x)
```

```{r}
# number of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_exp_elas)

# fraction of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_exp_elas)/count(asv_count_unknowns_2024_exp_elas)

# number of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_exp_elas))

# fraction of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_exp_elas))/sum(rowSums(asv_count_unknowns_2024_exp_elas))
```

##### Summary of Expedition Results of REVAMP Filtering:
MiFish: 6.5% of ASVs were removed as unknowns (0.9% of total reads). 2009 ASVs retained (13,286,471 reads). 
Elas02: 60.6% of ASVs were removed as unknowns (20.8% of total reads). 1247 ASVs retained (19,000,859 reads). 

### Trawl
#### Mifish-
```{r}
asv_count_unknowns_2024_trawl_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFish/processed_tables/ASVs_counts_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_unknowns_2024_trawl_mifish) <- asv_count_unknowns_2024_trawl_mifish$x
asv_count_unknowns_2024_trawl_mifish <- asv_count_unknowns_2024_trawl_mifish %>% select(-x)

asv_count_nounknowns_2024_trawl_mifish <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-MiFish/processed_tables/ASVs_counts_NOUNKNOWNS_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_nounknowns_2024_trawl_mifish) <- asv_count_nounknowns_2024_trawl_mifish$x
asv_count_nounknowns_2024_trawl_mifish <- asv_count_nounknowns_2024_trawl_mifish %>% select(-x)
```

```{r}
# number of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_trawl_mifish)

# fraction of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_trawl_mifish)/count(asv_count_unknowns_2024_trawl_mifish)

# number of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_trawl_mifish))

# fraction of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_trawl_mifish))/sum(rowSums(asv_count_unknowns_2024_trawl_mifish))

```


#### Elas02-
```{r}
asv_count_unknowns_2024_trawl_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02/processed_tables/ASVs_counts_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_unknowns_2024_trawl_elas) <- asv_count_unknowns_2024_trawl_elas$x
asv_count_unknowns_2024_trawl_elas <- asv_count_unknowns_2024_trawl_elas %>% select(-x)

asv_count_nounknowns_2024_trawl_elas <- read.delim("/Volumes/easystore/eDNA/shirp-edna/results-revamp-2024-Elas02/processed_tables/ASVs_counts_NOUNKNOWNS_controlsRemoved.tsv", header=TRUE, stringsAsFactors=FALSE)
row.names(asv_count_nounknowns_2024_trawl_elas) <- asv_count_nounknowns_2024_trawl_elas$x
asv_count_nounknowns_2024_trawl_elas <- asv_count_nounknowns_2024_trawl_elas %>% select(-x)
```

```{r}
# number of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_trawl_elas)

# fraction of ASVs retained after removal of unknowns
count(asv_count_nounknowns_2024_trawl_elas)/count(asv_count_unknowns_2024_trawl_elas)

# number of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_trawl_elas))

# fraction of reads retained after removal of unknowns
sum(rowSums(asv_count_nounknowns_2024_trawl_elas))/sum(rowSums(asv_count_unknowns_2024_trawl_elas))
```

##### Summary of Trawl Results of REVAMP Filtering:
MiFish: 8.1% of ASVs were removed as unknowns (1.4% of total reads). 1691 ASVs retained (12,096,417 reads). 
Elas02: 58.8% of ASVs were removed as unknowns (29.2% of total reads). 1500 ASVs retained (16,625,907 reads). 






# QC and filtering


## Rarefaction curves

```{r}
# output from phyloseq needs to be converted to matrix and transposed
table1 <- otu_table(phylo_2024_exp_mifish)
class(table1) <- "matrix" 
table1 <- t(table1) 

table2 <- otu_table(phylo_2024_exp_elas)
class(table2) <- "matrix" 
table2 <- t(table2) 

table3 <- otu_table(phylo_2024_trawl_mifish)
class(table3) <- "matrix" 
table3 <- t(table3) 

table4 <- otu_table(phylo_2024_trawl_elas)
class(table4) <- "matrix" 
table4 <- t(table4) 

rarecurve(table1, step=50, cex=0.5)
rarecurve(table2, step=50, cex=0.5)
rarecurve(table3, step=50, cex=0.5)
rarecurve(table4, step=50, cex=0.5)


```

View sample sums, sort from min to max, to flag low-sequencing-effort samples:
```{r}
as.data.frame(sort(sample_sums(phylo_2024_exp_mifish)))
as.data.frame(sort(sample_sums(phylo_2024_exp_elas)))
as.data.frame(sort(sample_sums(phylo_2024_trawl_mifish)))
as.data.frame(sort(sample_sums(phylo_2024_trawl_elas)))

```

MiFish/ expedition: Keep en eye on sample 7_8
Elas/ expedition: There are a few many samples (8_15, 2_11, 2_13, ...) that are low reads- keep an eye to see if these get filtered out later. They may be those areas that have no/few elasmos
MiFish/trawl: Other than controls, most look good in terms of sequencing effort
Elas/ trawl: Other than controls, most look good in terms of sequencing effort





## Curating

For quick reference, scan through Krona plots:
- 2024 MiFish expedition dataset [here](/results-revamp-2024-MiFish-expedition/Figures/00_KRONA_plots/results-revamp-2024-MiFish-expedition_samplesSummedKRONA.html)  
- 2024 Elas02 expedition dataset [here](/results-revamp-2024-Elas02-expedition/Figures/00_KRONA_plots/results-revamp-2024-Elas02-expedition_samplesSummedKRONA.html)
- 2024 MiFish trawl dataset [here](/results-revamp-2024-MiFish/Figures/00_KRONA_plots/results-revamp-2024-MiFish_samplesSummedKRONA.html)
- 2024 Elas02 trawl dataset [here](/results-revamp-2024-Elas02/Figures/00_KRONA_plots/results-revamp-2024-Elas02_samplesSummedKRONA.html)

- Note, unknowns in Krona plots were already removed from phylo objects. Also the Krona plots from the trawl include all samples, including those from earlier in season

- Scan REVAMP output in REVAMP directories
  - MiFIsh/ expedition example: `ASV2Taxonomy/results-revamp-2024-MiFish-expedition_asvTaxonomyTable.txt` and `ASV2Taxonomy/ASVcounts_mergedOnTaxonomy.txt` have taxonomy of all ASVs. Look closely at controls: Negative controls, C_2, C_3 and positive controls, C_4, and C_5 for high read-number entries (ignoring unknowns and things I already removed like bacteria, mammals)
  - Elas02: For these, all controls should be negative controls (because there were no elasmobranchs in the control tanks).

### Replace NAs in taxonomy 
because this becomes problematic when filtering.
There are some abundant taxa resolved only to the genus or family level. 

Check what they look like before replacement
```{r}
# Exp/ MiFish
data.frame(tax_table(phylo_2024_exp_mifish)) # all taxa
data.frame(tax_table(subset_taxa(phylo_2024_exp_mifish, is.na(Species)))) # taxa with NAs

# Exp/ Elas
data.frame(tax_table(phylo_2024_exp_elas))
data.frame(tax_table(subset_taxa(phylo_2024_exp_elas, is.na(Species))))

# Trawl/ MiFish
data.frame(tax_table(phylo_2024_trawl_mifish))
data.frame(tax_table(subset_taxa(phylo_2024_trawl_mifish, is.na(Species))))

# Trawl/ Elas
data.frame(tax_table(phylo_2024_trawl_elas))
data.frame(tax_table(subset_taxa(phylo_2024_trawl_elas, is.na(Species))))
```


```{r}
# Replace NA in taxa list with next highest annotated taxon"
tax_table(phylo_2024_exp_mifish) <- tax_table(fantaxtic::name_na_taxa(phylo_2024_exp_mifish, include_rank = T))

tax_table(phylo_2024_exp_elas) <- tax_table(fantaxtic::name_na_taxa(phylo_2024_exp_elas, include_rank = T))

tax_table(phylo_2024_trawl_mifish) <- tax_table(fantaxtic::name_na_taxa(phylo_2024_trawl_mifish, include_rank = T))

tax_table(phylo_2024_trawl_elas) <- tax_table(fantaxtic::name_na_taxa(phylo_2024_trawl_elas, include_rank = T))

# Check after replacement
data.frame(tax_table(phylo_2024_exp_mifish))
data.frame(tax_table(phylo_2024_exp_elas))
data.frame(tax_table(phylo_2024_trawl_mifish))
data.frame(tax_table(phylo_2024_trawl_elas))

```




### Check taxonomy 
#### Expedition-MiFish
```{r}
ranks <- rank_names(phylo_2024_exp_mifish)
ranks

as.data.frame(unique(tax_table(phylo_2024_exp_mifish)[, ranks[1]]))
as.data.frame(unique(tax_table(phylo_2024_exp_mifish)[, ranks[2]]))
as.data.frame(unique(tax_table(phylo_2024_exp_mifish)[, ranks[3]]))

nrow(tax_table(phylo_2024_exp_mifish)) # number of taxa before filtering
```

#### Expedition-Elas02
```{r}
ranks <- rank_names(phylo_2024_exp_elas)
ranks

as.data.frame(unique(tax_table(phylo_2024_exp_elas)[, ranks[1]]))
as.data.frame(unique(tax_table(phylo_2024_exp_elas)[, ranks[2]]))
as.data.frame(unique(tax_table(phylo_2024_exp_elas)[, ranks[3]]))

nrow(tax_table(phylo_2024_exp_elas)) # number of taxa before filtering
```

#### Trawl-MiFish
```{r}
ranks <- rank_names(phylo_2024_trawl_mifish)
ranks

as.data.frame(unique(tax_table(phylo_2024_trawl_mifish)[, ranks[1]]))
as.data.frame(unique(tax_table(phylo_2024_trawl_mifish)[, ranks[2]]))
as.data.frame(unique(tax_table(phylo_2024_trawl_mifish)[, ranks[3]]))

nrow(tax_table(phylo_2024_trawl_mifish)) # number of taxa before filtering
```

#### Trawl-Elas02
```{r}
ranks <- rank_names(phylo_2024_trawl_elas)
ranks

as.data.frame(unique(tax_table(phylo_2024_trawl_elas)[, ranks[1]]))
as.data.frame(unique(tax_table(phylo_2024_trawl_elas)[, ranks[2]]))
as.data.frame(unique(tax_table(phylo_2024_trawl_elas)[, ranks[3]]))

nrow(tax_table(phylo_2024_trawl_elas)) # number of taxa before filtering
```


#### Start filtering by taxonomy

Meanwhile, rename *filtered* phyloseq objects to `ps` from `phylo`. 
So `ps2024_exp_mifish`. Unfiltered is `phylo_2024_exp_mifish`, etc.

##### Remove prokaryotes
MiFish/ Expedition-
```{r}
nrow(tax_table(phylo_2024_exp_mifish)) # number of taxa before filtering
ps2024_exp_mifish <- subset_taxa(phylo_2024_exp_mifish, !Kingdom == 'Bacteria')
nrow(tax_table(ps2024_exp_mifish)) # number of taxa left
unique(tax_table(ps2024_exp_mifish)[, ranks[1]])
```
--> Lost ~40% of the unique taxa by removing Bacteria from Exp/MiFish library


Elas02/ Expedition-
There are no Bacteria in Exp/Elas02 library

MiFish/ Trawl-
```{r}
nrow(tax_table(phylo_2024_trawl_mifish)) # number of taxa before filtering
ps2024_trawl_mifish <- subset_taxa(phylo_2024_trawl_mifish, !Kingdom == 'Bacteria')
nrow(tax_table(ps2024_trawl_mifish)) # number of taxa left
unique(tax_table(ps2024_trawl_mifish)[, ranks[1]])
```
--> Lost ~15% of the unique taxa by removing Bacteria from Trawl/MiFish library

Elas02/ Trawl-
There are no Bacteria in Exp/Elas02 library


Check mammals:

MiFish/ Expedition-
```{r}
mammals_2024_exp_mifish <- subset_taxa(ps2024_exp_mifish, Class == 'Mammalia')
unique(tax_table(mammals_2024_exp_mifish)[, ranks[7]])

```
These are the typical contaminants: dog, mouse, human, pig, raccoon, cow. 
The only interesting one (that I will keep in) is Megaptera novaeangliae, the humpback whale!- keep this one in.



Elasmo/ Expedition-
```{r}
mammals_2024_exp_elas <- subset_taxa(phylo_2024_exp_elas, Class == 'Mammalia')
unique(tax_table(mammals_2024_exp_elas)[, ranks[7]])
```
These are the typical contamination- human, pig, undulates, shrew(?). Delete all.


MiFish/ Trawl-
```{r}
mammals_2024_trawl_mifish <- subset_taxa(ps2024_trawl_mifish, Class == 'Mammalia')
unique(tax_table(mammals_2024_trawl_mifish)[, ranks[7]])

```
Delete all mammals in this case.

Elasmo/ trawl
```{r}
mammals_2024_trawl_elas <- subset_taxa(phylo_2024_trawl_elas, Class == 'Mammalia')
unique(tax_table(mammals_2024_trawl_elas)[, ranks[7]])
```
Delete all mammals in this case.


##### Remove non-marine mammals


Exp/MiFish-
```{r}
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[7]]))
nrow(tax_table(ps2024_exp_mifish)) # number of ASVs before filtering

ps2024_exp_mifish <- subset_taxa(ps2024_exp_mifish, !Species == 'Canis lupus' & !Species == 'Mus musculus' & !Species == 'Homo sapiens' & !Species == 'Sus scrofa' & !Species == 'Unknown Canis (Genus)' & !Species == 'Procyon lotor' & !Species == 'Bos taurus')

nrow(tax_table(ps2024_exp_mifish)) # number of ASVs left
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[7]]))
```
1148 species taxa remain from the original 2085


Exp/Elas02- 
```{r}
nrow(tax_table(phylo_2024_exp_elas)) # number of taxa before filtering
ps2024_exp_elas <- subset_taxa(phylo_2024_exp_elas, !Class == 'Mammalia')
nrow(tax_table(ps2024_exp_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_exp_elas)[, ranks[7]]))

```
1232 unique taxa remain

Trawl/MiFish-
```{r}
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[7]]))
nrow(tax_table(ps2024_trawl_mifish)) # number of ASVs before filtering

ps2024_trawl_mifish <- subset_taxa(ps2024_trawl_mifish, !Class == 'Mammalia')

nrow(tax_table(ps2024_trawl_mifish)) # number of ASVs left
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[7]]))
```
1417 unique taxa remain 


Trawl/Elas02- 
```{r}
nrow(tax_table(phylo_2024_trawl_elas)) # number of taxa before filtering
ps2024_trawl_elas <- subset_taxa(phylo_2024_trawl_elas, !Class == 'Mammalia')
nrow(tax_table(ps2024_trawl_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_trawl_elas)[, ranks[7]]))

```
1528 unique taxa remain



##### Remove the Aves

```{r}
# subset_taxa(ps2024_exp_mifish, Class == 'Aves')

subset_taxa(ps2024_exp_elas, Class == 'Aves')
unique(tax_table(subset_taxa(ps2024_exp_elas, Class == 'Aves')))

subset_taxa(ps2024_trawl_mifish, Class == 'Aves')
unique(tax_table(subset_taxa(ps2024_trawl_mifish, Class == 'Aves')))

subset_taxa(ps2024_trawl_elas, Class == 'Aves')
unique(tax_table(subset_taxa(ps2024_trawl_elas, Class == 'Aves')))
```
Expedition:
MiFish- there are none
Elas02- remove 1 taxon: chicken

Trawl:
Mifish- 3 taxa from: chicken and song sparrow
Elas- 6 taxa from chicken and turkey

--> Remove all Aves

```{r}
# ps2024_exp_mifish <-   subset_taxa(ps2024_exp_mifish, !Class == 'Aves')
nrow(tax_table(ps2024_exp_mifish)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[7]]))

ps2024_exp_elas <-   subset_taxa(ps2024_exp_elas, !Class == 'Aves')
nrow(tax_table(ps2024_exp_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_exp_elas)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_exp_elas)[, ranks[7]]))

ps2024_trawl_mifish <-   subset_taxa(ps2024_trawl_mifish, !Class == 'Aves')
nrow(tax_table(ps2024_trawl_mifish)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[7]]))

ps2024_trawl_elas <-   subset_taxa(ps2024_trawl_elas, !Class == 'Aves')
nrow(tax_table(ps2024_trawl_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_trawl_elas)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_trawl_elas)[, ranks[7]]))
```

##### Remove wrong tax assignments
M. henlei is likely M. canis. It is very low abundance but also likely wrong tax assignment because M. henlei is from the Pacific. Remove (it is a very small proportion of total reads- won't change any interpretation)
Same for M. mosis and M griseus- remove these. They are likely a misannotation of M. canis. They are only from the Indian Ocean, Red Sea, or western Pacific


```{r}
# ps2024_exp_mifish <- subset_taxa(ps2024_exp_mifish, !Species %in% c('Mustelus henlei', 'Mustelus mosis','Mustelus griseus'))
nrow(tax_table(ps2024_exp_mifish)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_exp_mifish)[, ranks[7]]))

ps2024_exp_elas <-   subset_taxa(ps2024_exp_elas, !Species %in% c('Mustelus henlei', 'Mustelus mosis','Mustelus griseus'))
nrow(tax_table(ps2024_exp_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_exp_elas)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_exp_elas)[, ranks[7]]))

# ps2024_trawl_mifish <-   subset_taxa(ps2024_trawl_mifish, !Species %in% c('Mustelus henlei', 'Mustelus mosis', 'Mustelus griseus'))
nrow(tax_table(ps2024_trawl_mifish)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_trawl_mifish)[, ranks[7]]))

ps2024_trawl_elas <-   subset_taxa(ps2024_trawl_elas, !Species %in% c('Mustelus henlei', 'Mustelus mosis', 'Mustelus griseus'))
nrow(tax_table(ps2024_trawl_elas)) # number of taxa left
as.data.frame(unique(tax_table(ps2024_trawl_elas)[, ranks[4]]))
as.data.frame(unique(tax_table(ps2024_trawl_elas)[, ranks[7]]))
```


Other things to keep an eye on:

- For now I aggregated all Brevoortia () as "Menhaden." Later on these should be looked at more closely. Some times the hits are to Gulf menhaden and sometimes to Finescale menhaden but Atlsntic menhaden is the species that *should* be there...


#### Summary Diveristy stats- USV vs Trawl
After QC and curation, these are the number of ASVs left:
Expedition/MiFish: 1148
Expedition/Elas02: 1230
SeptemberTrawl/MiFish: 1414
SeptemberTrawl/Elas02: 1423

After QC and curation, these are the number of unique Orders left:
Expedition/MiFish: 26
Expedition/Elas02: 18
SeptemberTrawl/MiFish: 31
SeptemberTrawl/Elas02: 15

After QC and curation, these are the number of unique Species left:
Expedition/MiFish: 62
Expedition/Elas02: 29
SeptemberTrawl/MiFish: 80
SeptemberTrawl/Elas02: 28

How many reads are left in each library?
```{r}
sum(apply(otu_table(ps2024_exp_mifish), 2, as.numeric))
sum(apply(otu_table(ps2024_exp_elas), 2, as.numeric))
sum(apply(otu_table(ps2024_trawl_mifish), 2, as.numeric))
sum(apply(otu_table(ps2024_trawl_elas), 2, as.numeric))

```

### Add in common names

Import common names from my ongoing list
```{r}
commonnames <- read_csv(file = "../eDNA-databases/commonnames.csv")
```

Update phyloseq objects with common name column
```{r}
# Extract, update, tax_table
taxonomy_exp_mifish <- as.data.frame(tax_table(ps2024_exp_mifish)) %>%
  rownames_to_column("ASV") %>%
  left_join(commonnames, by = "Species") 
row.names(taxonomy_exp_mifish) <- taxonomy_exp_mifish$ASV
taxonomy_exp_mifish <- taxonomy_exp_mifish %>% select(-ASV)
# Update the phyloseq object
tax_table(ps2024_exp_mifish) <- as.matrix(taxonomy_exp_mifish)

taxonomy_exp_elas <- as.data.frame(tax_table(ps2024_exp_elas)) %>%
  rownames_to_column("ASV") %>%
  left_join(commonnames, by = "Species") 
row.names(taxonomy_exp_elas) <- taxonomy_exp_elas$ASV
taxonomy_exp_elas <- taxonomy_exp_elas %>% select(-ASV)
# Update the phyloseq object
tax_table(ps2024_exp_elas) <- as.matrix(taxonomy_exp_elas)

taxonomy_trawl_mifish <- as.data.frame(tax_table(ps2024_trawl_mifish)) %>%
  rownames_to_column("ASV") %>%
  left_join(commonnames, by = "Species") 
row.names(taxonomy_trawl_mifish) <- taxonomy_trawl_mifish$ASV
taxonomy_trawl_mifish <- taxonomy_trawl_mifish %>% select(-ASV)
# Update the phyloseq object
tax_table(ps2024_trawl_mifish) <- as.matrix(taxonomy_trawl_mifish)

taxonomy_trawl_elas <- as.data.frame(tax_table(ps2024_trawl_elas)) %>%
  rownames_to_column("ASV") %>%
  left_join(commonnames, by = "Species") 
row.names(taxonomy_trawl_elas) <- taxonomy_trawl_elas$ASV
taxonomy_trawl_elas <- taxonomy_trawl_elas %>% select(-ASV)
# Update the phyloseq object
tax_table(ps2024_trawl_elas) <- as.matrix(taxonomy_trawl_elas)


# Check
data.frame(tax_table(ps2024_exp_mifish))
data.frame(tax_table(ps2024_exp_elas))
data.frame(tax_table(ps2024_trawl_mifish))
data.frame(tax_table(ps2024_trawl_elas))
```




#### Filter based on Controls
Check remaining ASVs in neg controls to see what contamination is left

MiFish/ Expedition-
```{r}
data.frame(otu_table(ps2024_exp_mifish)[,which(sample_data(ps2024_exp_mifish)$controls == "negative")])
max(otu_table(ps2024_exp_mifish)[,which(sample_data(ps2024_exp_mifish)$controls == "negative")])
```

After removing typical contamination (bacteria, human, etc), the max read abundance remaining in the negative controls is 601- this is great. The highest was from ASV_1, menhaden, the most abundant ASV in the dataset overall.

Elas02/ Expedition-
```{r}
data.frame(otu_table(ps2024_exp_elas)[,which(sample_data(ps2024_exp_elas)$controls == "negative")])
max(otu_table(ps2024_exp_elas)[,which(sample_data(ps2024_exp_elas)$controls == "negative")])
```
After removing typical contamination (bacteria, human, mammals, aves, etc), the max read abundance remaining in the negative controls is 4984. The highest was from ASV_1, M. Canis, the most abundant ASV in the dataset overall. This is not as great but not terrible. 

MiFish/ Trawl-
```{r}
data.frame(otu_table(ps2024_trawl_mifish)[,which(sample_data(ps2024_trawl_mifish)$controls == "negative")])
max(otu_table(ps2024_trawl_mifish)[,which(sample_data(ps2024_trawl_mifish)$controls == "negative")])
```
After removing typical contamination (bacteria, human, mammals, aves, etc), the max read abundance remaining in the negative controls is 486. The highest was from ASV_1, menhaden, again the most abundant ASV in the dataset overall. 

Elas/ Trawl-
```{r}
data.frame(otu_table(ps2024_trawl_elas)[,which(sample_data(ps2024_trawl_elas)$controls == "negative")])
max(otu_table(ps2024_trawl_elas)[,which(sample_data(ps2024_trawl_elas)$controls == "negative")])
```
After removing typical contamination (bacteria, human, mammals, aves, etc), the max read abundance remaining in the negative controls is 1651. The highest was from ASV_1, Mustelus canis, again the most abundant ASV in the dataset overall. 




*POSITIVE CTL ANALYSIS- MiFish*
No positive controls were used in this Elas02 library

The remaining contamination issue is "cross-talk"- eg. some of the high abundance ASVs seem to bleed over, at  low abundances, into other samples. ASV_1 is an example (above) as well as some of the positive control species from MiFish library, which are not expected in the other samples (usually; these are tropical species in the positive controls. These are occasionally found in Shinnecock Bay, which is actually where they were taken from originally and put in the aquarium where we took the pos control samples from) but are also sometimes detected at very low read abundances. 

Check which species are abundant in the pos controls and check out the different in read abundance between "real" ASVs and cross-talk in positive controls

Exp/MiFish-
```{r}
df.pos <- as.data.frame(otu_table(ps2024_exp_mifish)[,which(sample_data(ps2024_exp_mifish)$controls == "positive")])

# arrange ASVs from pos ctl in descending order to see most abundant
df.pos <- df.pos %>% mutate(Sum = MP_C_4ES2_S25_L001+MP_C_5ES2_S25_L001) %>% arrange(desc(Sum))
df.pos
  
# what is the taxonomy of these
df.pos.ASVs <- as.data.frame(tax_table(phylo_2024_exp_mifish)[rownames(data.frame(otu_table(ps2024_exp_mifish)[,which(sample_data(ps2024_exp_mifish)$controls == "positive")]))])

df.pos.ASVs[rownames(df.pos),]
```

I believe the low read abundances (<~100 reads) are cross-talk, while the high read abundance (<10,000) are real but it's difficult to find a cutoff for contamination...

Top 5 hits in positive control samples are tropicals. 6th most aubndant, ASV_1, is menhaden, then 7th-15th are all tropicals. 16th is Anchoa mitchilli. Then 17th-21st are tropicals and 22nd is seaboard goby. 23rd is Black sea bass, 24th is Menidia menidia. 25th through 29th are tropicals and 30th is menhaden again. 31st to 34th are tropicals then 35th is Tautoga, 36th is Spot, 37th is Tautog, 38th is northern sennet (probably real) and 39th-41st are tropicals. Next set really start to blend between tropical/ pos controls and cross-talk. After 51st, it seems to be mostly cross-talk (not pos ctls) but with som eexceptions.

In terms of abundance, there is a big drop off from 1st to 2nd most abundant (225,980 --> 47,742), another from 3rd to 4th (36,343 --> 4,548), from 4th to 5th (4548 -->2820), from 14th to 15th (1338 --> 945), from 15th to 16th (945 --> 566), 24th-25th (357 --> 241) and the rest is a gradual decline. Read abundance of 51st is 115.

*DECISION* use 500 as a cutoff

Remove ASVs with less than 500 reads in a sample. 

Exp/MiFish-
```{r}
data.frame(otu_table(ps2024_exp_mifish)) # compare before

ps2024_exp_mifish <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_exp_mifish,
  minabund = 500,
  relabund = FALSE)

data.frame(otu_table(ps2024_exp_mifish)) # and after
```

Note that the above also removed rows for ASVs which no longer exist after setting the min threshold.

423 taxa remain

```{r}
sum(apply(otu_table(ps2024_exp_mifish), 2, as.numeric))
```
10586263 reads remain


Exp/Elas02-
```{r}
data.frame(otu_table(ps2024_exp_elas)) # compare before

ps2024_exp_elas <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_exp_elas,
  minabund = 500,
  relabund = FALSE)

data.frame(otu_table(ps2024_exp_elas)) # and after
```
448 taxa remain.

```{r}
sum(apply(otu_table(ps2024_exp_elas), 2, as.numeric))
```
18235253 reads remain


Trawl/MiFish-
```{r}
data.frame(otu_table(ps2024_trawl_mifish)) # compare before

ps2024_trawl_mifish <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_trawl_mifish,
  minabund = 500,
  relabund = FALSE)

data.frame(otu_table(ps2024_trawl_mifish)) # and after
```
200 taxa remain

```{r}
sum(apply(otu_table(ps2024_trawl_mifish), 2, as.numeric))
```
3952477 reads remain



Trawl/Elas02-
```{r}
data.frame(otu_table(ps2024_trawl_elas)) # compare before

ps2024_trawl_elas <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_trawl_elas,
  minabund = 500,
  relabund = FALSE)

data.frame(otu_table(ps2024_trawl_elas)) # and after
```
235 taxa remain

```{r}
sum(apply(otu_table(ps2024_trawl_elas), 2, as.numeric))
```
6957043 reads remain


### Agglomerate by taxonomy
Generate new otu tables after grouping ASVs by annotated species name
Exp/MiFish-
```{r}
ps2024_exp_mifish_glommed <- tax_glom(ps2024_exp_mifish, "Species.CommonName")

# plot total reads
plot_bar(ps2024_exp_mifish_glommed, x = "Name.Deploy_Cartr_Library")

# view tax_table
data.frame(tax_table(ps2024_exp_mifish_glommed))
```



Exp/Elas02-
```{r}
ps2024_exp_elas_glommed <- tax_glom(ps2024_exp_elas, "Species.CommonName")

# plot total reads
plot_bar(ps2024_exp_elas_glommed, x = "Name_Deploy_Cartr_Library")

# view tax_table
data.frame(tax_table(ps2024_exp_elas_glommed))
```


Trawl/MiFish-
```{r}
ps2024_trawl_mifish_glommed <- tax_glom(ps2024_trawl_mifish, "Species.CommonName")

# plot total reads
plot_bar(ps2024_trawl_mifish_glommed)

# view tax_table
data.frame(tax_table(ps2024_trawl_mifish_glommed))
```

Trawl/MiFish-
```{r}
ps2024_trawl_elas_glommed <- tax_glom(ps2024_trawl_elas, "Species.CommonName")

# plot total reads
plot_bar(ps2024_trawl_elas_glommed)

# view tax_table
data.frame(tax_table(ps2024_trawl_elas_glommed))
```


### Remove samples with low total number of reads. 
Based on both libraries above, there is a sharp difference between the low abundant and high abundant samples. Use cutoff of 25,000 for both.

(Note- this will delete the negative controls too)

Exp/MiFish-
```{r}
ps2024_exp_mifish_glommed <- prune_samples(sample_sums(ps2024_exp_mifish_glommed)>=25000, ps2024_exp_mifish_glommed)
ps2024_exp_mifish <- prune_samples(sample_sums(ps2024_exp_mifish)>=25000, ps2024_exp_mifish)

# plot again
plot_bar(ps2024_exp_mifish_glommed, x = "Name.Deploy_Cartr_Library")

# how many samples remain?
dim(sample_data(ps2024_exp_mifish_glommed))[1]
dim(sample_data(ps2024_exp_mifish))[1]
```
Looks good. Sample 7_8, which was the one I flagged in rarefaction analysis, did not pass this QC (in addition to others). Rest look great. 91 samples remain.


Exp/ Elas02-
```{r}
ps2024_exp_elas_glommed <- prune_samples(sample_sums(ps2024_exp_elas_glommed)>=25000, ps2024_exp_elas_glommed)
ps2024_exp_elas <- prune_samples(sample_sums(ps2024_exp_elas)>=25000, ps2024_exp_elas)

# plot again
plot_bar(ps2024_exp_elas_glommed, x = "Name_Deploy_Cartr_Library")

# how many samples remain?
dim(sample_data(ps2024_exp_elas_glommed))[1]
dim(sample_data(ps2024_exp_elas))[1]
```

Looks good. All low effort samples removed, including controls. Rest look great. 61 Elas02 samples remain.

Trawl/MiFish-
```{r}
ps2024_trawl_mifish_glommed <- prune_samples(sample_sums(ps2024_trawl_mifish_glommed)>=25000, ps2024_trawl_mifish_glommed)

ps2024_trawl_mifish <- prune_samples(sample_sums(ps2024_trawl_mifish)>=25000, ps2024_trawl_mifish)

# plot again
plot_bar(ps2024_trawl_mifish_glommed)

# how many samples remain?
dim(sample_data(ps2024_trawl_mifish_glommed))[1]
dim(sample_data(ps2024_trawl_mifish))[1]
```

29 samples remain

Trawl/Elas-
```{r}
ps2024_trawl_elas_glommed <- prune_samples(sample_sums(ps2024_trawl_elas_glommed)>=25000, ps2024_trawl_elas_glommed)

ps2024_trawl_elas <- prune_samples(sample_sums(ps2024_trawl_elas)>=25000, ps2024_trawl_elas)

# plot again
plot_bar(ps2024_trawl_elas_glommed)

# how many samples remain?
dim(sample_data(ps2024_trawl_elas_glommed))[1]
dim(sample_data(ps2024_trawl_elas))[1]
```
28 samples remain

### Export Tables

Exp/MiFish-
```{r}
mifish_2024_exp_asv_table_taxbased <- data.frame(otu_table(ps2024_exp_mifish_glommed))
mifish_2024_exp_tax_table_taxbased <- rownames_to_column(data.frame(tax_table(ps2024_exp_mifish_glommed)), var = "1stRepresentative_ASV")
mifish_2024_exp_sample_data_taxbased <- data.frame(sample_data(ps2024_exp_mifish_glommed))


# view
mifish_2024_exp_asv_table_taxbased
mifish_2024_exp_tax_table_taxbased
mifish_2024_exp_sample_data_taxbased

# export
write.csv(mifish_2024_exp_asv_table_taxbased,"figures-expedition/mifish_2024_exp_asv_table_taxbased.csv", row.names = TRUE)
write.csv(mifish_2024_exp_tax_table_taxbased,"figures-expedition/mifish_2024_exp_tax_table_taxbased.csv", row.names = FALSE)
write.csv(mifish_2024_exp_sample_data_taxbased,"figures-expedition/mifish_2024_exp_sample_data_taxbased.csv", row.names = TRUE)
```
After removal of low-abundant samples, how many ASVs and reads?
```{r}
dim(tax_table(mifish_2024_exp_asv_table_taxbased))[1] # of unique species
nrow(tax_table(ps2024_exp_mifish)) # number of ASVs left
sum(apply(otu_table(ps2024_exp_mifish), 2, as.numeric)) # number of reads
```


Exp/Elas02-
```{r}
elas_2024_exp_asv_table_taxbased <- data.frame(otu_table(ps2024_exp_elas_glommed))
elas_2024_exp_tax_table_taxbased <- rownames_to_column(data.frame(tax_table(ps2024_exp_elas_glommed)), var = "1stRepresentative_ASV")
elas_2024_exp_sample_data_taxbased <- data.frame(sample_data(ps2024_exp_elas_glommed))


# view
elas_2024_exp_asv_table_taxbased
elas_2024_exp_tax_table_taxbased
elas_2024_exp_sample_data_taxbased

# export
write.csv(elas_2024_exp_asv_table_taxbased,"figures-expedition/elas_2024_exp_asv_table_taxbased.csv", row.names = TRUE)
write.csv(elas_2024_exp_tax_table_taxbased,"figures-expedition/elas_2024_exp_tax_table_taxbased.csv", row.names = FALSE)
write.csv(elas_2024_exp_sample_data_taxbased,"figures-expedition/elas_2024_exp_sample_data_taxbased.csv", row.names = TRUE)
```
After removal of low-abundant samples, how many ASVs and reads?
```{r}
dim(tax_table(elas_2024_exp_asv_table_taxbased))[1] # of unique species
nrow(tax_table(ps2024_exp_elas)) # number of ASVs left
sum(apply(otu_table(ps2024_exp_elas), 2, as.numeric)) # number of reads
```



Trawl/MiFish-
```{r}
mifish_2024_trawl_asv_table_taxbased <- data.frame(otu_table(ps2024_trawl_mifish_glommed))
mifish_2024_trawl_tax_table_taxbased <- rownames_to_column(data.frame(tax_table(ps2024_trawl_mifish_glommed)), var = "1stRepresentative_ASV")
mifish_2024_trawl_sample_data_taxbased <- data.frame(sample_data(ps2024_trawl_mifish_glommed))


# view
mifish_2024_trawl_asv_table_taxbased
mifish_2024_trawl_tax_table_taxbased
mifish_2024_trawl_sample_data_taxbased

# export
write.csv(mifish_2024_trawl_asv_table_taxbased,"figures-expedition/mifish_Sept2024_trawl_asv_table_taxbased.csv", row.names = TRUE)
write.csv(mifish_2024_trawl_tax_table_taxbased,"figures-expedition/mifish_Sept2024_trawl_tax_table_taxbased.csv", row.names = FALSE)
write.csv(mifish_2024_trawl_sample_data_taxbased,"figures-expedition/mifish_Sept2024_trawl_sample_data_taxbased.csv", row.names = TRUE)
```

After removal of low-abundant samples, how many ASVs and reads?
```{r}
dim(tax_table(mifish_2024_trawl_asv_table_taxbased))[1] # of unique species
nrow(tax_table(ps2024_trawl_mifish)) # number of ASVs left
sum(apply(otu_table(ps2024_trawl_mifish), 2, as.numeric)) # number of reads
```



Trawl/Elas-
```{r}
elas_2024_trawl_asv_table_taxbased <- data.frame(otu_table(ps2024_trawl_elas_glommed))
elas_2024_trawl_tax_table_taxbased <- rownames_to_column(data.frame(tax_table(ps2024_trawl_elas_glommed)), var = "1stRepresentative_ASV")
elas_2024_trawl_sample_data_taxbased <- data.frame(sample_data(ps2024_trawl_elas_glommed))


# view
elas_2024_trawl_asv_table_taxbased
elas_2024_trawl_tax_table_taxbased
elas_2024_trawl_sample_data_taxbased

# export
write.csv(elas_2024_trawl_asv_table_taxbased,"figures-expedition/elas_Sept2024_trawl_asv_table_taxbased.csv", row.names = TRUE)
write.csv(elas_2024_trawl_tax_table_taxbased,"figures-expedition/elas_Sept2024_trawl_tax_table_taxbased.csv", row.names = FALSE)
write.csv(elas_2024_trawl_sample_data_taxbased,"figures-expedition/elas_Sept2024_trawl_sample_data_taxbased.csv", row.names = TRUE)
```

After removal of low-abundant samples, how many ASVs and reads?
```{r}
dim(tax_table(elas_2024_trawl_asv_table_taxbased))[1] # of unique species
nrow(tax_table(ps2024_trawl_elas)) # number of ASVs left
sum(apply(otu_table(ps2024_trawl_elas), 2, as.numeric)) # number of reads
```


Also calculate *relative abundances* (# of ASV sequences/sum total sequences in sample), for some plotting

```{r}
ps2024_exp_mifish_ra <- microbiome::transform(ps2024_exp_mifish, transform = "compositional")
ps2024_exp_mifish_glommed_ra <- microbiome::transform(ps2024_exp_mifish_glommed, transform = "compositional")

ps2024_exp_elas_ra <- microbiome::transform(ps2024_exp_elas, transform = "compositional")
ps2024_exp_elas_glommed_ra <- microbiome::transform(ps2024_exp_elas_glommed, transform = "compositional")

ps2024_trawl_mifish_ra <- microbiome::transform(ps2024_trawl_mifish, transform = "compositional")
ps2024_trawl_mifish_glommed_ra <- microbiome::transform(ps2024_trawl_mifish_glommed, transform = "compositional")

ps2024_trawl_elas_ra <- microbiome::transform(ps2024_trawl_elas, transform = "compositional")
ps2024_trawl_elas_glommed_ra <- microbiome::transform(ps2024_trawl_elas_glommed, transform = "compositional")
```



# Visualizations

##### Bar plots of top species from entire libraries
Expedition/ Mifish
```{r}
# Aggregate by Common Name
ps2024_exp_mifish_species <- tax_glom(ps2024_exp_mifish, taxrank = "Species.CommonName") 

# Summarize total abundances for each species across the whole dataset
exp_mifish_species_abundance <- data.frame(otu_table(ps2024_exp_mifish_species)) %>%
  rowSums() %>%
  as.data.frame() %>%
  rownames_to_column(var = "ASV") %>%
  rename(TotalAbundance = ".")

# Calculate relative abundances across the whole dataset
exp_mifish_species_abundance <- exp_mifish_species_abundance %>%
  mutate(RelativeAbundance = TotalAbundance / sum(TotalAbundance))

# Add back taxonomic information
rm(tax_info)
tax_info <- as.data.frame(tax_table(ps2024_exp_mifish_species))
tax_info <- tax_info %>%
  mutate(ASV = rownames(tax_info))


exp_mifish_species_abundance <- exp_mifish_species_abundance %>%
  left_join(tax_info, by = c("ASV" = "ASV"))

# Retain only most abundant sp
exp_mifish_species_abundance <- exp_mifish_species_abundance %>%
  arrange(desc(RelativeAbundance)) %>%
  slice_head(n = 12) # Show top 12 species

# Remove ASV column
exp_mifish_species_abundance <- exp_mifish_species_abundance %>% select(-ASV)

# Add columns indicating which library and sample type
exp_mifish_species_abundance$library <- "MiFish"
exp_mifish_species_abundance$sample_type <- "USV"


exp_mifish_species_abundance
```


Expedition/ Elas
```{r}
# Aggregate at the "Species" level
ps2024_exp_elas_species <- tax_glom(ps2024_exp_elas, taxrank = "Species.CommonName") 

# Summarize total abundances for each species across the whole dataset
exp_elas_species_abundance <- data.frame(otu_table(ps2024_exp_elas_species)) %>%
  rowSums() %>%
  as.data.frame() %>%
  rownames_to_column(var = "ASV") %>%
  rename(TotalAbundance = ".")

# Calculate relative abundances across the whole dataset
exp_elas_species_abundance <- exp_elas_species_abundance %>%
  mutate(RelativeAbundance = TotalAbundance / sum(TotalAbundance))

# Add back taxonomic information
rm(tax_info)
tax_info <- as.data.frame(tax_table(ps2024_exp_elas_species))
tax_info <- tax_info %>%
  mutate(ASV = rownames(tax_info))

exp_elas_species_abundance <- exp_elas_species_abundance %>%
  left_join(tax_info, by = c("ASV" = "ASV"))

# Plot only most abundant
exp_elas_species_abundance <- exp_elas_species_abundance %>%
  arrange(desc(RelativeAbundance)) %>%
  slice_head(n = 2) # Show top 2 species

# Remove ASV column
exp_elas_species_abundance <- exp_elas_species_abundance %>% select(-ASV)

# Add columns indicating which library and sample type
exp_elas_species_abundance$library <- "Elas02"
exp_elas_species_abundance$sample_type <- "USV"

exp_elas_species_abundance
```

Trawl/ Mifish
```{r}
# Aggregate at the "Species" level
ps2024_trawl_mifish_species <- tax_glom(ps2024_trawl_mifish, taxrank = "Species.CommonName") 

# Summarize total abundances for each species across the whole dataset
trawl_mifish_species_abundance <- data.frame(otu_table(ps2024_trawl_mifish_species)) %>%
  rowSums() %>%
  as.data.frame() %>%
  rownames_to_column(var = "ASV") %>%
  rename(TotalAbundance = ".")

# Calculate relative abundances across the whole dataset
trawl_mifish_species_abundance <- trawl_mifish_species_abundance %>%
  mutate(RelativeAbundance = TotalAbundance / sum(TotalAbundance))

# Add back taxonomic information
rm(tax_info)
tax_info <- as.data.frame(tax_table(ps2024_trawl_mifish_species))
tax_info <- tax_info %>%
  mutate(ASV = rownames(tax_info))


trawl_mifish_species_abundance <- trawl_mifish_species_abundance %>%
  left_join(tax_info, by = c("ASV" = "ASV"))

# Plot only most abundant
trawl_mifish_species_abundance <- trawl_mifish_species_abundance %>%
  arrange(desc(RelativeAbundance)) %>%
  slice_head(n = 12) # Show top 12 species

# Remove ASV column
trawl_mifish_species_abundance <- trawl_mifish_species_abundance %>% select(-ASV)

# Add columns indicating which library and sample type
trawl_mifish_species_abundance$library <- "MiFish"
trawl_mifish_species_abundance$sample_type <- "Hand Sample"

trawl_mifish_species_abundance
```

Trawl/ Elas
```{r}
# Aggregate at the "Species" level
ps2024_trawl_elas_species <- tax_glom(ps2024_trawl_elas, taxrank = "Species.CommonName") 

# Summarize total abundances for each species across the whole dataset
trawl_elas_species_abundance <- data.frame(otu_table(ps2024_trawl_elas_species)) %>%
  rowSums() %>%
  as.data.frame() %>%
  rownames_to_column(var = "ASV") %>%
  rename(TotalAbundance = ".")

# Calculate relative abundances across the whole dataset
trawl_elas_species_abundance <- trawl_elas_species_abundance %>%
  mutate(RelativeAbundance = TotalAbundance / sum(TotalAbundance))

# Add back taxonomic information
rm(tax_info)
tax_info <- as.data.frame(tax_table(ps2024_trawl_elas_species))
tax_info <- tax_info %>%
  mutate(ASV = rownames(tax_info))

trawl_elas_species_abundance <- trawl_elas_species_abundance %>%
  left_join(tax_info, by = c("ASV" = "ASV"))

# Plot only most abundant
trawl_elas_species_abundance <- trawl_elas_species_abundance %>%
  arrange(desc(RelativeAbundance)) %>%
  slice_head(n = 2) # Show top 2 species

# Remove ASV column
trawl_elas_species_abundance <- trawl_elas_species_abundance %>% select(-ASV)

# Add columns indicating which library and sample type
trawl_elas_species_abundance$library <- "Elas02"
trawl_elas_species_abundance$sample_type <- "Hand Sample"

trawl_elas_species_abundance
```

Sum what % of total the top species comprise
```{r}
sum(exp_mifish_species_abundance$RelativeAbundance)
sum(trawl_mifish_species_abundance$RelativeAbundance)
sum(exp_elas_species_abundance$RelativeAbundance)
sum(trawl_elas_species_abundance$RelativeAbundance)

```


Append the four datasets
```{r}
most_abund_all4_datasets <- exp_mifish_species_abundance %>%
  bind_rows(trawl_mifish_species_abundance) %>%
  bind_rows(exp_elas_species_abundance) %>%
  bind_rows(trawl_elas_species_abundance)


most_abund_all4_datasets
```



Fix colors so they remain constant in following plots
Some [predefined color names](https://sape.inf.usi.ch/quick-reference/ggplot2/colour) for reference
I started a colors column in commonnames database to keep assignment consistent across notebooks, but they got lost from the df when aggregating. Join back in and format for plotting
```{r}

myColors_sciname <- setNames(commonnames$Color, commonnames$Species)
myColors_comname <- setNames(commonnames$Color, commonnames$CommonName)

head(myColors_sciname)
head(myColors_comname)
```

Plot stacked barplot
```{r}
# Plot a stacked barplot
top_species_abundance_plot <- ggplot(most_abund_all4_datasets, aes(x = sample_type, y = RelativeAbundance, fill = CommonName)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent_format()) + 
  scale_fill_manual(values = myColors_comname) +
  facet_grid(~library) +
  labs(x = NULL, y = "Relative Abundance (%)", title = "Relative Abundance of Top Species: Expedition vs. Hand Samples") +
  theme_minimal() +
  guides(fill = guide_legend(ncol = 2)) +  # Adjust # of legend columns
  theme(legend.title = element_blank())
  
  

top_species_abundance_plot

ggsave(plot = top_species_abundance_plot, filename = "figures-expedition/top_species_abundance_plot.jpg")

```


## Simple barplots by sample

Exp/MiFish-

raw reads
```{r}
ps2024_exp_mifish_barplot <- plot_bar(ps2024_exp_mifish, x = "Name.Deploy_Cartr_Library", fill = "Order")
ps2024_exp_mifish_barplot
```

relative abundances
```{r}
ps2024_exp_ra_mifish_barplot <- plot_bar(ps2024_exp_mifish_ra, x = "Name.Deploy_Cartr_Library", fill = "Order")
ps2024_exp_ra_mifish_barplot
```

Exp/Elas02-

raw reads
```{r}
ps2024_exp_elas_barplot <- plot_bar(ps2024_exp_elas, x = "Name_Deploy_Cartr_Library", fill = "Species")
ps2024_exp_elas_barplot
```

relative abundances
```{r}
ps2024_exp_ra_elas_barplot <- plot_bar(ps2024_exp_elas_ra, x = "Name_Deploy_Cartr_Library", fill = "Species")
ps2024_exp_ra_elas_barplot
```


Trawl/MiFish-

raw reads
```{r}
ps2024_trawl_mifish_barplot <- plot_bar(ps2024_trawl_mifish, fill = "Order")
ps2024_trawl_mifish_barplot
```

relatve abundances
```{r}
ps2024_trawl_ra_mifish_barplot <- plot_bar(ps2024_trawl_mifish_ra, fill = "Order")
ps2024_trawl_ra_mifish_barplot
```

Trawl/Elas02-

raw reads
```{r}
ps2024_trawl_elas_barplot <- plot_bar(ps2024_trawl_elas, fill = "Species")
ps2024_trawl_elas_barplot
```

relatve abundances
```{r}
ps2024_trawl_ra_elas_barplot <- plot_bar(ps2024_trawl_elas_ra, fill = "Species")
ps2024_trawl_ra_elas_barplot
```


## Examine controls 

### Plot positive controls

#### Exp/MiFish-
(no Elasmo pos controls)

```{r}
# Make new df with positive controls and remove ASVs that are not represented
ps2024_exp_mifish_glommed_posctl <- subset_samples(ps2024_exp_mifish_glommed, controls=="positive")
ps2024_exp_mifish_glommed_ra_posctl <- subset_samples(ps2024_exp_mifish_glommed_ra, controls=="positive")


# Use metagMisc to remove ASV rows with 0 abundance for all positive samples
ps2024_exp_mifish_glommed_posctl <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_exp_mifish_glommed_posctl,
  minabund = 0,
  relabund = FALSE)

ps2024_exp_mifish_glommed_ra_posctl <- prune_taxa(taxa_names(ps2024_exp_mifish_glommed_posctl),ps2024_exp_mifish_glommed_ra_posctl)
```


```{r}
ps2024_exp_mifish_posctl_barplot <- plot_bar(ps2024_exp_mifish_glommed_posctl, fill = "CommonName", title = "2024 Expedition: Pos Controls: Read Abun") + 
  scale_y_continuous(name="Read Abundance")+
  theme_minimal() +
  theme(axis.title.x=element_blank(), legend.title = element_blank(), axis.text.x = element_blank())+
  scale_fill_manual(values = myColors_comname) 
ps2024_exp_mifish_posctl_barplot

ps2024_exp_mifish_posctl_ra_barplot <- plot_bar(ps2024_exp_mifish_glommed_ra_posctl, fill = "CommonName", title = "2024 Expedition: Pos Controls: Rel Abun") + 
  scale_y_continuous(name="Relative Abundance")+
  theme_minimal() +
  theme(axis.title.x=element_blank(), legend.title = element_blank(), axis.text.x = element_blank())+
  scale_fill_manual(values = myColors_comname) 
ps2024_exp_mifish_posctl_ra_barplot



ggsave(plot = ps2024_exp_mifish_posctl_barplot, filename = "figures-expedition/2024_exp_mifish_posctl_barplot.jpg", width = 4, height = 4, units = "in")
ggsave(plot = ps2024_exp_mifish_posctl_ra_barplot, filename = "figures-expedition/2024_exp_mifish_posctl_ra_barplot.jpg", width = 4, height = 4, units = "in")

ggsave(plot = ps2024_exp_mifish_posctl_barplot, filename = "figures-expedition/2024_exp_mifish_posctl_barplot.eps", width = 4, height = 4, units = "in")
ggsave(plot = ps2024_exp_mifish_posctl_ra_barplot, filename = "figures-expedition/2024_exp_mifish_posctl_ra_barplot.eps", width = 4, height = 4, units = "in")

```



Remove Pos and Neg  Controls from all MiFish phyloseq objects:
(Note, they were already removed from Elas obkects just based on quality filtering above)

ASV-based, reads:
ps2024_exp_mifish

ASV-based, relative abundance:
ps2024_exp_mifish_ra

Taxonomy (species)- based, reads:
ps2024_exp_mifish_glommed

Taxonomy (species)- based, relative abundance:
ps2024_exp_mifish_glommed_ra


```{r}
ps2024_exp_mifish <- subset_samples(ps2024_exp_mifish, is.na(controls))
ps2024_exp_mifish_ra <- subset_samples(ps2024_exp_mifish_ra, is.na(controls))
ps2024_exp_mifish_glommed <- subset_samples(ps2024_exp_mifish_glommed, is.na(controls))
ps2024_exp_mifish_glommed_ra <- subset_samples(ps2024_exp_mifish_glommed_ra, is.na(controls))
```

### Trawl/MiFish-
(no Elasmo pos controls)

```{r}
# Make new df with positive controls and remove ASVs that are not represented
ps2024_trawl_mifish_glommed_posctl <- subset_samples(ps2024_trawl_mifish_glommed, controls=="positive")
ps2024_trawl_mifish_glommed_ra_posctl <- subset_samples(ps2024_trawl_mifish_glommed_ra, controls=="positive")

# Use metagMisc to remove ASV rows with 0 abundance for all positive samples
ps2024_trawl_mifish_glommed_posctl <- metagMisc::phyloseq_filter_sample_wise_abund_trim(
  ps2024_trawl_mifish_glommed_posctl,
  minabund = 0,
  relabund = FALSE)

ps2024_trawl_mifish_glommed_ra_posctl <- prune_taxa(taxa_names(ps2024_trawl_mifish_glommed_posctl),ps2024_trawl_mifish_glommed_ra_posctl)
```




```{r}
ps2024_trawl_mifish_posctl_barplot <- plot_bar(ps2024_trawl_mifish_glommed_posctl, fill = "CommonName", title = "2024 Trawl (Sept. only): Pos Controls: Read Abun") + 
  scale_y_continuous(name="Read Abundance")+
  theme_minimal() +
  theme(axis.title.x=element_blank(), legend.title = element_blank())+
  scale_fill_manual(values = myColors_comname) 
ps2024_trawl_mifish_posctl_barplot

ps2024_trawl_mifish_posctl_ra_barplot <- plot_bar(ps2024_trawl_mifish_glommed_ra_posctl, fill = "CommonName", title = "2024 Trawl (Sept. only): Pos Controls: Rel Abun") + 
  scale_y_continuous(name="Relative Abundance")+
  theme_minimal() +
  theme(axis.title.x=element_blank(), legend.title = element_blank())+
  scale_fill_manual(values = myColors_comname) 
ps2024_trawl_mifish_posctl_ra_barplot


# save
ggsave(plot = ps2024_trawl_mifish_posctl_barplot, filename = "figures-expedition/2024_trawl_mifish_posctl_barplot.eps", width = 4, height = 4, units = "in")
ggsave(plot = ps2024_trawl_mifish_posctl_ra_barplot, filename = "figures-expedition/2024_trawl_mifish_posctl_ra_barplot.eps", width = 4, height = 4, units = "in")

ggsave(plot = ps2024_trawl_mifish_posctl_barplot, filename = "figures-expedition/2024_trawl_mifish_posctl_barplot.jpg", width = 4, height = 4, units = "in")
ggsave(plot = ps2024_trawl_mifish_posctl_ra_barplot, filename = "figures-expedition/2024_trawl_mifish_posctl_ra_barplot.jpg", width = 4, height = 4, units = "in")

```



## Bubble plots

Based on my previous [scripts](https://github.com/lizsuter/Cariaco_Euk)

Work with tax-based dataframes (rather than ASV-based):

Taxonomy (species)- based, reads:
ps2024_exp_mifish_glommed

Taxonomy (species)- based, relative abundance:
ps2024_exp_mifish_glommed_ra

### Expedition/MiFish-
```{r}
# convert ps object to dataframe using phyloseq's psmelt
ps2024_exp_mifish_glommed_df <- psmelt(ps2024_exp_mifish_glommed)
ps2024_exp_mifish_glommed_ra_df <- psmelt(ps2024_exp_mifish_glommed_ra)

# replace zeroes in the table with NA
ps2024_exp_mifish_glommed_df[ps2024_exp_mifish_glommed_df == 0] <- NA
ps2024_exp_mifish_glommed_ra_df[ps2024_exp_mifish_glommed_ra_df == 0] <- NA

# and remove rows with NAs (so they don't appear as small dots in plot)
ps2024_exp_mifish_glommed_df <-  filter(ps2024_exp_mifish_glommed_df, !is.na(Abundance))
ps2024_exp_mifish_glommed_ra_df <-  filter(ps2024_exp_mifish_glommed_ra_df, !is.na(Abundance))


# and view
ps2024_exp_mifish_glommed_df
ps2024_exp_mifish_glommed_ra_df
```

Elas02-
```{r}
# convert ps object to dataframe using phyloseq's psmelt
ps2024_exp_elas_glommed_df <- psmelt(ps2024_exp_elas_glommed)
ps2024_exp_elas_glommed_ra_df <- psmelt(ps2024_exp_elas_glommed_ra)

# replace zeroes in the table with NA
ps2024_exp_elas_glommed_df[ps2024_exp_elas_glommed_df == 0] <- NA
ps2024_exp_elas_glommed_ra_df[ps2024_exp_elas_glommed_ra_df == 0] <- NA

# and remove rows with NAs (so they don't appear as small dots in plot)
ps2024_exp_elas_glommed_df <-  filter(ps2024_exp_elas_glommed_df, !is.na(Abundance))
ps2024_exp_elas_glommed_ra_df <-  filter(ps2024_exp_elas_glommed_ra_df, !is.na(Abundance))

# and view
ps2024_exp_elas_glommed_df
ps2024_exp_elas_glommed_ra_df
```



Plot species-common name by site

MiFish-

```{r}

# First sort the site names in a sensible way
levels(unique(c(ps2024_exp_mifish_glommed_df$sites)))
sitelevels <- as.character(sort(as.numeric(levels(unique(c(ps2024_exp_mifish_glommed_df$sites))))))
sitelevels

# Order E-W in sensible way by making it a factor
ps2024_exp_mifish_glommed_df$Bayside_f= factor(ps2024_exp_mifish_glommed_df$Bayside, levels=c('W','E'))

```



Plot by bayside
```{r}
# First average replicates at same sites
ps2024_exp_mifish_glommed_df_bayside <- ps2024_exp_mifish_glommed_df %>%
    group_by(sites, Bayside_f, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_mifish_glommed_df_bayside



bubbleplot_comname_2024_expedition_mifish_Bayside <- ggplot(ps2024_exp_mifish_glommed_df_bayside, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Bayside_f, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_mifish_Bayside


  
  
# save
ggsave(plot = bubbleplot_comname_2024_expedition_mifish_Bayside, filename = "figures-expedition/bubbleplot_comname_2024_expedition_mifish_Bayside.eps", width = 10, height = 7, units = "in")

ggsave(plot = bubbleplot_comname_2024_expedition_mifish_Bayside, filename = "figures-expedition/bubbleplot_comname_2024_expedition_mifish_Bayside.jpg", width = 10, height = 7, units = "in")
```

Plot by DayNight
```{r}
# First average replicates at same sites
ps2024_exp_mifish_glommed_df_daynight <- ps2024_exp_mifish_glommed_df %>%
    group_by(sites, Night__Day, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_mifish_glommed_df_daynight


bubbleplot_comname_2024_expedition_mifish_DayNight <- ggplot(ps2024_exp_mifish_glommed_df_daynight, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Night__Day, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_mifish_DayNight


ggsave(plot = bubbleplot_comname_2024_expedition_mifish_DayNight, filename = "figures-expedition/bubbleplot_comname_2024_expedition_mifish_DayNight.eps", width = 10, height = 7, units = "in")
```

Plot by Habitat
```{r}
# First average replicates at same sites
ps2024_exp_mifish_glommed_df_habitat <- ps2024_exp_mifish_glommed_df %>%
    group_by(sites, Habitat, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_mifish_glommed_df_habitat


bubbleplot_comname_2024_expedition_mifish_Habitat <- ggplot(ps2024_exp_mifish_glommed_df_habitat, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Habitat, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_mifish_Habitat

ggsave(plot = bubbleplot_comname_2024_expedition_mifish_Habitat, filename = "figures-expedition/bubbleplot_comname_2024_expedition_mifish_Habitat.eps", width = 12, height = 7, units = "in")
```
Plot by Bayside and Day-Night
```{r}
# First average replicates at same sites
ps2024_exp_mifish_glommed_df_bayside_daynight <- ps2024_exp_mifish_glommed_df %>%
    group_by(sites, Bayside_f, Night__Day, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_mifish_glommed_df_bayside_daynight


bubbleplot_comname_2024_expedition_mifish_Bayside_DayNight <- ggplot(ps2024_exp_mifish_glommed_df_bayside_daynight, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(Night__Day~Bayside_f, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_mifish_Bayside_DayNight




ggsave(plot = bubbleplot_comname_2024_expedition_mifish_Bayside_DayNight, filename = "figures-expedition/bubbleplot_comname_2024_expedition_mifish_Bayside_DayNight.eps", width = 10, height = 9, units = "in")

```





### Elas02-

```{r}

# First sort the site names in a sensible way
levels(unique(c(ps2024_exp_elas_glommed_df$sites)))
sitelevels <- as.character(sort(as.numeric(levels(unique(c(ps2024_exp_elas_glommed_df$sites))))))
sitelevels

# Order E-W in sensible way by making it a factor
ps2024_exp_elas_glommed_df$Bayside_f= factor(ps2024_exp_elas_glommed_df$Bayside, levels=c('W','E'))

```



Plot by bayside
```{r}
# First average replicates at same sites
ps2024_exp_elas_glommed_df_bayside <- ps2024_exp_elas_glommed_df %>%
    group_by(sites, Bayside_f, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_elas_glommed_df_bayside



bubbleplot_comname_2024_expedition_elas_Bayside <- ggplot(ps2024_exp_elas_glommed_df_bayside, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Bayside_f, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_elas_Bayside

# save
ggsave(plot = bubbleplot_comname_2024_expedition_elas_Bayside, filename = "figures-expedition/bubbleplot_comname_2024_expedition_elas_Bayside.eps", width = 8, height = 2.5, units = "in")

ggsave(plot = bubbleplot_comname_2024_expedition_elas_Bayside, filename = "figures-expedition/bubbleplot_comname_2024_expedition_elas_Bayside.jpg", width = 8, height = 2.5, units = "in")
```

Plot by DayNight
```{r}
# First average replicates at same sites
ps2024_exp_elas_glommed_df_daynight <- ps2024_exp_elas_glommed_df %>%
    group_by(sites, Night__Day, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_elas_glommed_df_daynight


bubbleplot_comname_2024_expedition_elas_DayNight <- ggplot(ps2024_exp_elas_glommed_df_daynight, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Night__Day, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_elas_DayNight


ggsave(plot = bubbleplot_comname_2024_expedition_elas_DayNight, filename = "figures-expedition/bubbleplot_comname_2024_expedition_elas_DayNight.eps", width = 10, height = 2.5, units = "in")
```

Plot by Habitat
```{r}
# First average replicates at same sites
ps2024_exp_elas_glommed_df_habitat <- ps2024_exp_elas_glommed_df %>%
    group_by(sites, Habitat, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_elas_glommed_df_habitat


bubbleplot_comname_2024_expedition_elas_Habitat <- ggplot(ps2024_exp_elas_glommed_df_habitat, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(~Habitat, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_elas_Habitat

ggsave(plot = bubbleplot_comname_2024_expedition_elas_Habitat, filename = "figures-expedition/bubbleplot_comname_2024_expedition_elas_Habitat.eps", width = 10, height = 2.5, units = "in")
```
Plot by Bayside and Day-Night
```{r}
# First average replicates at same sites
ps2024_exp_elas_glommed_df_bayside_daynight <- ps2024_exp_elas_glommed_df %>%
    group_by(sites, Bayside_f, Night__Day, Species, CommonName, `Species.CommonName`) %>%
    dplyr::summarize(Abundance = mean(Abundance))
ps2024_exp_elas_glommed_df_bayside_daynight


bubbleplot_comname_2024_expedition_elas_Bayside_DayNight <- ggplot(ps2024_exp_elas_glommed_df_bayside_daynight, aes(x = factor(sites, levels = sitelevels), y = fct_rev(`Species.CommonName`))) + # the fancy stuff around y (`Species-CommonName`) helps to present it in reverse order in the plot (from top to btm alphabetically)
  geom_point(aes(size=ifelse(Abundance==0, NA, Abundance), fill = `CommonName`), color = "black", pch = 21) +
  scale_size_area(breaks = c(1000,10000,100000,1000000,10000000))+
  xlab("")+
  ylab("")+
  labs(size="Read Abundance", fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank(), axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 9)) +
  guides(fill="none") +
  facet_grid(Night__Day~Bayside_f, scales = "free", space = "free", drop= TRUE)
bubbleplot_comname_2024_expedition_elas_Bayside_DayNight




ggsave(plot = bubbleplot_comname_2024_expedition_elas_Bayside_DayNight, filename = "figures-expedition/bubbleplot_comname_2024_expedition_elas_Bayside_DayNight.eps", width = 10, height = 4, units = "in")

```






## Fractional Abundance Plots

Summarize fractional abundances across whole dataset-
```{r}
ps2024_exp_mifish_whole <- ps2024_exp_mifish_glommed_df %>%
  group_by(Species.CommonName) %>%
    summarize(total_reads = sum(Abundance)) %>%
  mutate(rel_abun = total_reads/sum(across(total_reads))) %>%
  mutate(rel_abun_percent = rel_abun*100) %>%
  mutate(csum = rev(cumsum(rev(rel_abun))), 
         pos = rel_abun/2 + lead(csum, 1),
         pos = if_else(is.na(pos), rel_abun/2, pos))

ps2024_exp_mifish_whole

```



Apparently there is no geom for pie charts but you can [build a stacked geom_bar and make polar coordinates](https://r-graph-gallery.com/piechart-ggplot2.html)

I also found a color palette package with a few options for large number of diverging cartegories, [pals](https://github.com/kwstat/pals)

```{r}
# first filter out anything <1% rel abun
ps2024_exp_mifish_whole_forplot <- ps2024_exp_mifish_whole %>%
  filter(!rel_abun_percent < 1)

# Turn names into factor for plotting in correct order
ps2024_exp_mifish_whole_forplot$CommonName_f= factor(ps2024_exp_mifish_whole_forplot$Species.CommonName, levels=sort(unique(ps2024_exp_mifish_whole_forplot$Species.CommonName)))

# add "Other" row at bottom of factors which sums all taxa <1%
ps2024_exp_mifish_whole_forplot <- ps2024_exp_mifish_whole_forplot %>%
  add_row(`Species.CommonName` = "Other",
          `CommonName_f` = "Other",
          rel_abun = 1-sum(ps2024_exp_mifish_whole_forplot$rel_abun), 
          rel_abun_percent = 100-sum(ps2024_exp_mifish_whole_forplot$rel_abun_percent))
ps2024_exp_mifish_whole_forplot


# plot
piechart_2024_exp_mifish_all <- ggplot(ps2024_exp_mifish_whole_forplot, 
                                aes(x= "", 
                                    y = rel_abun_percent, 
                                    fill=factor(`Species.CommonName`, levels = `CommonName_f`))) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  xlab("")+
  ylab("")+
  labs(fill = "")+
  theme_bw() +
  scale_fill_manual(values = myColors_comname)+
  theme(axis.title.x=element_blank()) +
  geom_text(aes(label = round(rel_abun_percent,1)),
            position = position_stack(vjust = 0.5))

piechart_2024_exp_mifish_all


ggsave(plot = piechart_2024_exp_mifish_all, filename = "figures-expedition/piechart_2024_exp_mifish_all.eps", width = 12, height = 7, units = "in")

```


Alternatively, Krona plot
Following [this](https://github.com/markschl/embed_krona/blob/main/example.Rmd)
Compatible with phyloseq objects
Must run in the console:
```{r}
 # source('https://raw.githubusercontent.com/markschl/embed_krona/master/embed_krona.R')
 # plot_krona(ps2024_exp_mifish_glommed)
 # plot_krona(ps2024_exp_elas_glommed)
 
```

Manually changed the names in folder to 
Generates the [MiFish krona plot](krona_files/krona_1.html) and [Elas02 krona plot](krona_files/krona_2.html) as an html file in current working directory. 




## Replication
How do replicates compare?

```{r}
sample_data(ps2024_exp_mifish)$replicates
# 90 samples, with 73 unique levels. So there are 17 samples which were collected in duplicate

duplicate_IDs <- sample_data(ps2024_exp_mifish)$replicates[duplicated(sample_data(ps2024_exp_mifish)$replicates)]
duplicate_IDs

# make new phyloseq object with only replicates
ps2024_exp_reps <- subset_samples(ps2024_exp_mifish_glommed, replicates %in% duplicate_IDs)
ps2024_exp_reps_ra <- subset_samples(ps2024_exp_mifish_glommed_ra, replicates %in% duplicate_IDs)


ps2024_exp_barplot_replicates <- plot_bar(ps2024_exp_reps, x = "Name.Deploy_Cartr_Library", fill = "CommonName")+
  scale_fill_manual(values = myColors_comname)
ps2024_exp_barplot_replicates

ps2024_exp_ra_barplot_replicates_ra <- plot_bar(ps2024_exp_reps_ra, x = "Name.Deploy_Cartr_Library", fill = "CommonName")+
  scale_fill_manual(values = myColors_comname)
ps2024_exp_ra_barplot_replicates_ra

# view replicates pair-by-pair
ps2024_exp_ra_barplot_replicates_ra <- ps2024_exp_ra_barplot_replicates_ra +
    facet_grid(~replicates, scales = "free", space = "free", drop= TRUE)+
    scale_fill_manual(values = myColors_comname)+
    theme(legend.position = "none", axis.title.x = element_blank(), axis.text.x = element_text(size = 12), strip.text = element_text(size = 12))
ps2024_exp_ra_barplot_replicates_ra


ggsave(plot = ps2024_exp_ra_barplot_replicates_ra, filename = "figures-expedition/barplot_2024_expedition_replicates_sidebyside.eps", width = 12, height = 7, units = "in")

ggsave(plot = ps2024_exp_ra_barplot_replicates_ra, filename = "figures-expedition/barplot_2024_expedition_replicates_sidebyside.jpg", width = 12, height = 7, units = "in")
```

- Some replicates look very close to each other (~10 of the 17) while others do not. I manually checked the Sample Inventory. One issue may be filtration volume- these are not always consistent bc of the issues with overpressuring
- I also notice that the more diverse the sample is, the less similar the replicates are. eg. 5_19 and 8_11a

### Aitchison dissimilarity among repilcates


For [compositional data](https://www.frontiersin.org/journals/microbiology/articles/10.3389/fmicb.2017.02224/full), use Aitchison distance on CLR-transformed data


From [vegan](https://rdrr.io/cran/vegan/man/vegdist.html) documentation, "aitchison" method in `vegdist` automatically does the clr transformation before calculating the distance matrix. Phyloseq has [some options](https://joey711.github.io/phyloseq/distance.html) to do run vegdist with a phyloseq object using a `distance` function, however aitchison is not listed:
```{r}
dist_methods <- unlist(distanceMethodList)
print(dist_methods)
```

On the other hand, from the vegan documentation, Aitchison distance is just the Euclidean distance on clr-transformed data, so I can do a transformation first and then the Euclidean distance calculation:
```{r}
ps2024_exp_reps_clr <- microbiome::transform(ps2024_exp_reps, transform = 'clr')
ps2024_exp_reps_dist <- distance(ps2024_exp_reps_clr, method= "euclidean")

ps2024_exp_reps_dist_mat <- as.matrix(ps2024_exp_reps_dist)

ps2024_exp_reps_dist_df <- as.data.frame(ps2024_exp_reps_dist_mat)
ps2024_exp_reps_dist_df

write.csv(ps2024_exp_reps_dist_df,"figures-expedition/mifish_2024_exp_aitchisondistance_replicates.csv", row.names = TRUE)
```
Analyzed the above in Excel in the file, [mifish_2024_exp_aitchisondistance_replicates.xlsx](figures-expedition/mifish_2024_exp_aitchisondistance_replicates.xlsx)
- Highlighted dissimilarity index between replicates
- Calculated average dissimilarity between replicates = 12.18479861; SD = 2.75176089

Get dissimilarity indices and their average across whole dataset, just for comparison:
```{r}
ps2024_exp_clr <- microbiome::transform(ps2024_exp_mifish, transform = 'clr')
ps2024_exp_dist <- distance(ps2024_exp_clr, method= "euclidean")

ps2024_exp_dist_mat <- as.matrix(ps2024_exp_dist)

ps2024_exp_dist_df <- as.data.frame(ps2024_exp_dist_mat)
ps2024_exp_dist_df

# mean of all distance indices?
mean(ps2024_exp_dist)
sd(ps2024_exp_dist)

```
On average, across the whole dataset, the dissimilarity is 13.4 (SD 2.1) while the average dissimilarity between replicates is 12.2 (SD 2.8). It's good that the replicates are less dissimilar than the on average but these numbers don't seem very far apart, especially taking into account the standard deviation


## Site Occupancy

Present Presence/ Absence as site occupancy, eg. across all samples from XX habitat type or east/west etc etc, how many times did species X appear. Check out [Lawson Handley et al. 2019](https://onlinelibrary.wiley.com/doi/full/10.1002/edn3.5)

### MiFIsh

```{r}
# How many total samples taken in each habitat type?
Total_samples_habitat <- as.data.frame(samples_2024_exp_mifish) %>%
  group_by(Habitat) %>%
  count(name = "Habitat_sample_total") %>%
  na.omit()

# in east vs west?
Total_samples_EW <- as.data.frame(samples_2024_exp_mifish) %>%
  group_by(Bayside) %>%
  count(name = "Bayside_sample_total") %>%
  filter(!Bayside=='Control')

# in day vs night?
Total_samples_DayNight <- as.data.frame(samples_2024_exp_mifish) %>%
  group_by(Night__Day) %>%
  count(name = "Night_day_sample_total") %>%
  na.omit()

Total_samples_habitat
Total_samples_EW
Total_samples_DayNight
```

```{r}
# join sample totals to dataframe so there is a denomenator for the calculation
ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df, Total_samples_habitat, by = "Habitat")
ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df_2, Total_samples_EW, by = "Bayside")
ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df_2, Total_samples_DayNight, by = "Night__Day")


ps2024_exp_mifish_glommed_df_2

```

Calculate site occupancy for each species
```{r}
# Habitat
Species_occurences_habitat <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Habitat) %>%
  count(name = "Sp_occ_in_habitat")

ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df_2, Species_occurences_habitat, by = c("Habitat"="Habitat","Species.CommonName"="Species.CommonName"))

#Bayside
Species_occurences_bayside <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Bayside) %>%
  count(name = "Sp_occ_in_bayside")

ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df_2, Species_occurences_bayside, by = c("Bayside"="Bayside","Species.CommonName"="Species.CommonName"))

#Daynight
Species_occurences_daynight <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Night__Day) %>%
  count(name = "Sp_occ_in_DayNight")

ps2024_exp_mifish_glommed_df_2 <- full_join(ps2024_exp_mifish_glommed_df_2, Species_occurences_daynight, by = c("Night__Day"="Night__Day","Species.CommonName"="Species.CommonName"))


# Calculate occurrence over sample total
Species_occurences_habitat <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Habitat, Habitat_sample_total, Sp_occ_in_habitat) %>%
  mutate(Species_occurences_in_habitat = Sp_occ_in_habitat/Habitat_sample_total) %>%
  select(Species.CommonName, CommonName, Habitat, Species_occurences_in_habitat) %>%
  distinct()
Species_occurences_habitat

Species_occurences_bayside <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Bayside, Bayside_sample_total, Sp_occ_in_bayside) %>%
  mutate(Species_occurences_in_bayside = Sp_occ_in_bayside/Bayside_sample_total) %>%
  select(Species_occurences_in_bayside, CommonName, Bayside, Species_occurences_in_bayside) %>%
  distinct()
Species_occurences_bayside

Species_occurences_daynight <- ps2024_exp_mifish_glommed_df_2 %>%
  group_by(Species.CommonName, Night__Day, Night_day_sample_total, Sp_occ_in_DayNight) %>%
  mutate(Species_occurences_in_daynight = Sp_occ_in_DayNight/Night_day_sample_total) %>%
  select(Species.CommonName, CommonName, Night__Day, Species_occurences_in_daynight) %>%
  distinct()
Species_occurences_daynight


```

Plot
```{r}
speciesoccurrence_habitat <- ggplot(data = Species_occurences_habitat, aes(x = CommonName, y = Species_occurences_in_habitat, fill = Habitat))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"))
speciesoccurrence_habitat

speciesoccurrence_daynight <- ggplot(data = Species_occurences_daynight, aes(x = CommonName, y = Species_occurences_in_daynight, fill = Night__Day))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("cornsilk", "antiquewhite4"))
speciesoccurrence_daynight

speciesoccurrence_bayside <- ggplot(data = Species_occurences_bayside, aes(x = CommonName, y = Species_occurences_in_bayside, fill = Bayside))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +
  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("coral", "cornflowerblue"))
speciesoccurrence_bayside


ggsave(plot = speciesoccurrence_habitat, filename = "figures-expedition/speciesoccurrence_habitat.eps", width = 12, height = 5, units = "in")

ggsave(plot = speciesoccurrence_daynight, filename = "figures-expedition/speciesoccurrence_daynight.eps", width = 12, height = 5, units = "in")

ggsave(plot = speciesoccurrence_bayside, filename = "figures-expedition/speciesoccurrence_bayside.eps", width = 12, height = 5, units = "in")

ggsave(plot = speciesoccurrence_habitat, filename = "figures-expedition/speciesoccurrence_habitat.jpg", width = 12, height = 5, units = "in")

ggsave(plot = speciesoccurrence_daynight, filename = "figures-expedition/speciesoccurrence_daynight.jpg", width = 12, height = 5, units = "in")

ggsave(plot = speciesoccurrence_bayside, filename = "figures-expedition/speciesoccurrence_bayside.jpg", width = 12, height = 5, units = "in")

```

### Elas02

```{r}
# How many total samples taken in each habitat type?
Total_samples_habitat <- as.data.frame(samples_2024_exp_elas) %>%
  group_by(Habitat) %>%
  count(name = "Habitat_sample_total") %>%
  na.omit()

# in east vs west?
Total_samples_EW <- as.data.frame(samples_2024_exp_elas) %>%
  group_by(Bayside) %>%
  count(name = "Bayside_sample_total") %>%
  filter(!Bayside=='Control')

# in day vs night?
Total_samples_DayNight <- as.data.frame(samples_2024_exp_elas) %>%
  group_by(Night__Day) %>%
  count(name = "Night_day_sample_total") %>%
  na.omit()

Total_samples_habitat
Total_samples_EW
Total_samples_DayNight
```



```{r}
# join sample totals to dataframe so there is a denomenator for the calculation
ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df, Total_samples_habitat, by = "Habitat")
ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df_2, Total_samples_EW, by = "Bayside")
ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df_2, Total_samples_DayNight, by = "Night__Day")


# there are no elasmos detected at oyster reef sites so there is an empty row. Delete
ps2024_exp_elas_glommed_df_2 <- ps2024_exp_elas_glommed_df_2 %>% filter(!is.na(OTU))


ps2024_exp_elas_glommed_df_2

```


Calculate site occupancy for each species
```{r}
# Habitat
Species_occurences_habitat <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Habitat) %>%
  count(name = "Sp_occ_in_habitat")

ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df_2, Species_occurences_habitat, by = c("Habitat"="Habitat","Species.CommonName"="Species.CommonName"))

#Bayside
Species_occurences_bayside <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Bayside) %>%
  count(name = "Sp_occ_in_bayside")

ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df_2, Species_occurences_bayside, by = c("Bayside"="Bayside","Species.CommonName"="Species.CommonName"))

#Daynight
Species_occurences_daynight <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Night__Day) %>%
  count(name = "Sp_occ_in_DayNight")

ps2024_exp_elas_glommed_df_2 <- full_join(ps2024_exp_elas_glommed_df_2, Species_occurences_daynight, by = c("Night__Day"="Night__Day","Species.CommonName"="Species.CommonName"))


# Calculate occurrence over sample total
Species_occurences_habitat <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Habitat, Habitat_sample_total, Sp_occ_in_habitat) %>%
  mutate(Species_occurences_in_habitat = Sp_occ_in_habitat/Habitat_sample_total) %>%
  select(Species.CommonName, CommonName, Habitat, Species_occurences_in_habitat) %>%
  distinct()
Species_occurences_habitat

Species_occurences_bayside <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Bayside, Bayside_sample_total, Sp_occ_in_bayside) %>%
  mutate(Species_occurences_in_bayside = Sp_occ_in_bayside/Bayside_sample_total) %>%
  select(Species.CommonName, CommonName, Bayside, Species_occurences_in_bayside) %>%
  distinct()
Species_occurences_bayside

Species_occurences_daynight <- ps2024_exp_elas_glommed_df_2 %>%
  group_by(Species.CommonName, Night__Day, Night_day_sample_total, Sp_occ_in_DayNight) %>%
  mutate(Species_occurences_in_daynight = Sp_occ_in_DayNight/Night_day_sample_total) %>%
  select(Species.CommonName, CommonName, Night__Day, Species_occurences_in_daynight) %>%
  distinct()
Species_occurences_daynight


```



Plot
```{r}
speciesoccurrence_habitat <- ggplot(data = Species_occurences_habitat, aes(x = CommonName, y = Species_occurences_in_habitat, fill = Habitat))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +
  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"))
speciesoccurrence_habitat

speciesoccurrence_daynight <- ggplot(data = Species_occurences_daynight, aes(x = CommonName, y = Species_occurences_in_daynight, fill = Night__Day))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +
  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("cornsilk", "antiquewhite4"))
speciesoccurrence_daynight

speciesoccurrence_bayside <- ggplot(data = Species_occurences_bayside, aes(x = CommonName, y = Species_occurences_in_bayside, fill = Bayside))+
  geom_bar(stat = "identity", position = position_dodge(preserve = "single"), color = "black", linewidth = 0.25)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.title = element_blank(),
        text = element_text(size = 14)) +
  ylab("Species Occurrence")+
  xlab("")+
  scale_fill_manual(values = c("coral", "cornflowerblue"))
speciesoccurrence_bayside


ggsave(plot = speciesoccurrence_habitat, filename = "figures-expedition/speciesoccurrence_habitat_elas.eps", width = 5, height = 5, units = "in")

ggsave(plot = speciesoccurrence_daynight, filename = "figures-expedition/speciesoccurrence_daynight_elas.eps", width = 5, height = 5, units = "in")

ggsave(plot = speciesoccurrence_bayside, filename = "figures-expedition/speciesoccurrence_bayside_elas.eps", width = 5, height = 5, units = "in")




ggsave(plot = speciesoccurrence_habitat, filename = "figures-expedition/speciesoccurrence_habitat_elas.jpg", width = 5, height = 5, units = "in")

ggsave(plot = speciesoccurrence_daynight, filename = "figures-expedition/speciesoccurrence_daynight_elas.jpg", width = 5, height = 5, units = "in")

ggsave(plot = speciesoccurrence_bayside, filename = "figures-expedition/speciesoccurrence_bayside_elas.jpg", width = 5, height = 5, units = "in")

```


# Species Richness- 
```{r}
species_counts_exp_mifish <- ps2024_exp_mifish_glommed_df %>%
  group_by(Sample, Deployment, sites, replicates, site_altname, Volume_liter, lat, long, Bayside_f, Habitat, Site_type, Night__Day, Datecode, Month, Day, Avg_Depth_m, Avg_Temperature_C, Avg_Salinity_psu, Avg_Chlorophyll_ugL, Avg_Turbidity_NTU) %>%
  summarise(UniqueSpeciesCount = n_distinct(Species), .groups = "drop")

species_counts_exp_elas <- ps2024_exp_elas_glommed_df %>%
  group_by(Sample, Deployment, sites, replicates, Volume_liter, lat, long, Bayside_f, Habitat, Site_type, Night__Day, Datecode, Month, Day, Avg_Depth_m, Avg_Temperature_C, Avg_Salinity_psu, Avg_Chlorophyll_ugL, Avg_Turbidity_NTU) %>%
  summarise(UniqueSpeciesCount = n_distinct(Species), .groups = "drop")


species_counts_exp_mifish
species_counts_exp_elas

```


## Plot avg sp richness by bayside, habitat, etc.
First calculate averages
```{r}
species_stats_by_habitat_mifish <- species_counts_exp_mifish %>%
  group_by(Habitat) %>%
  summarise(
    AverageUniqueSpeciesCount = mean(UniqueSpeciesCount, na.rm = TRUE),
    StdDevUniqueSpeciesCount = sd(UniqueSpeciesCount, na.rm = TRUE)
  )

species_stats_by_habitat_mifish

species_stats_by_bayside_mifish <- species_counts_exp_mifish %>%
  group_by(Bayside_f) %>%
  summarise(
    AverageUniqueSpeciesCount = mean(UniqueSpeciesCount, na.rm = TRUE),
    StdDevUniqueSpeciesCount = sd(UniqueSpeciesCount, na.rm = TRUE)
  )

species_stats_by_bayside_mifish


species_stats_by_habitat_elas <- species_counts_exp_elas %>%
  group_by(Habitat) %>%
  summarise(
    AverageUniqueSpeciesCount = mean(UniqueSpeciesCount, na.rm = TRUE),
    StdDevUniqueSpeciesCount = sd(UniqueSpeciesCount, na.rm = TRUE)
  )

species_stats_by_habitat_elas

species_stats_by_bayside_elas <- species_counts_exp_elas %>%
  group_by(Bayside_f) %>%
  summarise(
    AverageUniqueSpeciesCount = mean(UniqueSpeciesCount, na.rm = TRUE),
    StdDevUniqueSpeciesCount = sd(UniqueSpeciesCount, na.rm = TRUE)
  )

species_stats_by_bayside_elas
```
Plot
```{r}
# Put line breaks in x-tick labels for plotting
species_stats_by_habitat_mifish$Habitat <- gsub(" ", "\n", species_stats_by_habitat_mifish$Habitat)
species_stats_by_habitat_elas$Habitat <- gsub(" ", "\n", species_stats_by_habitat_elas$Habitat)


#Plot
species_richness_by_habitat_mifish_plot <- 
ggplot(species_stats_by_habitat_mifish, aes(x = Habitat, y = AverageUniqueSpeciesCount)) +
  geom_bar(stat = "identity", fill = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"), alpha = 0.8) +  
  geom_errorbar(aes(ymin = AverageUniqueSpeciesCount - StdDevUniqueSpeciesCount,
                    ymax = AverageUniqueSpeciesCount + StdDevUniqueSpeciesCount), 
                width = 0.2, color = "black") +  # Error bars
  labs(x = "", y = "Avg Species Richness") +  
  theme_minimal() 
species_richness_by_habitat_mifish_plot

species_richness_by_bayside_mifish_plot <- 
ggplot(species_stats_by_bayside_mifish, aes(x = Bayside_f, y = AverageUniqueSpeciesCount)) +
  geom_bar(stat = "identity", fill = c("cornflowerblue", "coral"), alpha = 0.8) +  
  geom_errorbar(aes(ymin = AverageUniqueSpeciesCount - StdDevUniqueSpeciesCount,
                    ymax = AverageUniqueSpeciesCount + StdDevUniqueSpeciesCount), 
                width = 0.2, color = "black") +  # Error bars
  labs(x = "", y = "Avg Species Richness") +  
  theme_minimal() 
species_richness_by_bayside_mifish_plot

species_richness_by_habitat_elas_plot <- 
ggplot(species_stats_by_habitat_elas, aes(x = Habitat, y = AverageUniqueSpeciesCount)) +
  geom_bar(stat = "identity", fill = c("azure2", "chartreuse4", "cadetblue1"), alpha = 0.8) +  
  geom_errorbar(aes(ymin = AverageUniqueSpeciesCount - StdDevUniqueSpeciesCount,
                    ymax = AverageUniqueSpeciesCount + StdDevUniqueSpeciesCount), 
                width = 0.2, color = "black") +  # Error bars
  labs(x = "", y = "Avg Species Richness") +  
  theme_minimal() 
species_richness_by_habitat_elas_plot

species_richness_by_bayside_elas_plot <- 
ggplot(species_stats_by_bayside_elas, aes(x = Bayside_f, y = AverageUniqueSpeciesCount)) +
  geom_bar(stat = "identity", fill = c("cornflowerblue", "coral"), alpha = 0.8) +  
  geom_errorbar(aes(ymin = AverageUniqueSpeciesCount - StdDevUniqueSpeciesCount,
                    ymax = AverageUniqueSpeciesCount + StdDevUniqueSpeciesCount), 
                width = 0.2, color = "black") +  # Error bars
  labs(x = "", y = "Avg Species Richness") +  
  theme_minimal() 
species_richness_by_bayside_elas_plot


```

save
```{r}
ggsave(plot = species_richness_by_habitat_mifish_plot, filename = "figures-expedition/species_richness_by_habitat_mifish_plot.jpg", width = 4, height = 4, units = "in")

ggsave(plot = species_richness_by_bayside_mifish_plot, filename = "figures-expedition/species_richness_by_bayside_mifish_plot.jpg", width = 2.5, height = 4, units = "in")

ggsave(plot = species_richness_by_habitat_elas_plot, filename = "figures-expedition/species_richness_by_habitat_elas_plot.jpg", width = 4, height = 4, units = "in")

ggsave(plot = species_richness_by_bayside_elas_plot, filename = "figures-expedition/species_richness_by_bayside_elas_plot.jpg", width = 2.5, height = 4, units = "in")

```

# Multivariate Analysis

## PCA
PCA is essentially a type of PCoA using the Euclidean distance matrix as input. When combined with a log-ratio transformation of the count table, this is deemed appropriate for compositional datasets. It is also recommended as a first step in exploratory analyses of sequencinging datasets.

First do a CLR, centered log ratio transformation of the absolute abundance data (after filtering), as suggested by [Gloor et al. 2017](https://www.frontiersin.org/journals/microbiology/articles/10.3389/fmicb.2017.02224/full) for compositional data
```{r}
exp_mifish_glommed_clr <- data.frame(compositions::clr(otu_table(ps2024_exp_mifish)))
exp_elas_glommed_clr <- data.frame(compositions::clr(otu_table(ps2024_exp_elas)))

```

Generate PCA
```{r}
lograt_pca_mifish_exp <- prcomp(t(exp_mifish_glommed_clr)) 
lograt_pca_elas_exp <- prcomp(t(exp_elas_glommed_clr))

```

Screeplots
```{r}
lograt_variances_mifish_exp <- as.data.frame(lograt_pca_mifish_exp$sdev^2/sum(lograt_pca_mifish_exp$sdev^2)) %>% #Extract axes
  # Format to plot
  select(PercVar = 'lograt_pca_mifish_exp$sdev^2/sum(lograt_pca_mifish_exp$sdev^2)') %>% 
  rownames_to_column(var = "PCaxis") %>% 
  data.frame
head(lograt_variances_mifish_exp)

ggplot(lograt_variances_mifish_exp, aes(x = as.numeric(PCaxis), y = PercVar)) + 
  geom_bar(stat = "identity", fill = "grey", color = "black") +
  theme_minimal() +
  theme(axis.title = element_text(color = "black", face = "bold", size = 10),
        axis.text.y = element_text(color = "black", face = "bold"),
        axis.text.x = element_blank()) +
  labs(x = "PC axis", y = "% Variance", title = "Log-Ratio PCA Screeplot, CLR Tranformation- MiFish/ Expedition")


lograt_variances_elas_exp <- as.data.frame(lograt_pca_elas_exp$sdev^2/sum(lograt_pca_elas_exp$sdev^2)) %>% #Extract axes
  # Format to plot
  select(PercVar = 'lograt_pca_elas_exp$sdev^2/sum(lograt_pca_elas_exp$sdev^2)') %>% 
  rownames_to_column(var = "PCaxis") %>% 
  data.frame
head(lograt_variances_elas_exp)

ggplot(lograt_variances_elas_exp, aes(x = as.numeric(PCaxis), y = PercVar)) + 
  geom_bar(stat = "identity", fill = "grey", color = "black") +
  theme_minimal() +
  theme(axis.title = element_text(color = "black", face = "bold", size = 10),
        axis.text.y = element_text(color = "black", face = "bold"),
        axis.text.x = element_blank()) +
  labs(x = "PC axis", y = "% Variance", title = "Log-Ratio PCA Screeplot, CLR Tranformation- Elas02/ Expedition")


```
First two axes are quite strong for both libraries


Extract variances from the clr pca
(Note [this issue](https://github.com/joey711/phyloseq/issues/1322) with converting rownames to column from a phyloseq object.... it was giving me a swuare 28x28 table rather than the full table. Needed to modify)
```{r}
pca_lograt_mifish_exp_df <- data.frame(lograt_pca_mifish_exp$x) %>% 
  rownames_to_column(var = "SampleID")

# Merge metadata into the pca data table
pca_lograt_mifish_exp_df <- sample_data(ps2024_exp_mifish_glommed) %>% data.frame() %>% 
  rownames_to_column(var = "SampleID") %>% 
right_join(pca_lograt_mifish_exp_df, by = "SampleID")

pca_lograt_mifish_exp_df


pca_lograt_elas_exp_df <- data.frame(lograt_pca_elas_exp$x) %>% 
  rownames_to_column(var = "SampleID")

# Merge metadata into the pca data table
pca_lograt_elas_exp_df <- sample_data(ps2024_exp_elas_glommed) %>% data.frame() %>% 
  rownames_to_column(var = "SampleID") %>% 
right_join(pca_lograt_elas_exp_df, by = "SampleID")

pca_lograt_elas_exp_df
```

Select eigenvalues from dataframe, round to 4 places and multiply by 100 for plotting. These will be the axes for the 3-D plot
```{r}
eigenvalues_pca_mifish_exp <-round(lograt_variances_mifish_exp[,2], digits = 4)*100
eigenvalues_pca_elas_exp <-round(lograt_variances_elas_exp[,2], digits = 4)*100
```

### Plot PCA
Use two axes since first two PCs explain large proportion of variance
```{r}
pca_mifish_exp_bayside_plot <- ggplot(pca_lograt_mifish_exp_df, aes(x = PC1, y = PC2, color = Bayside)) +
  geom_point(size = 3, alpha = 0.8) + 
  labs(x = paste0('PC1 ',eigenvalues_pca_mifish_exp[1],'%'), y = paste0('PC2 ',eigenvalues_pca_mifish_exp[2],'%'), color = "Bayside") +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14) #
  ) +
  scale_color_manual(values = c("coral","cornflowerblue"))
pca_mifish_exp_bayside_plot

pca_elas_exp_bayside_plot <- ggplot(pca_lograt_elas_exp_df, aes(x = PC1, y = PC2, color = Bayside)) +
  geom_point(size = 3, alpha = 0.8) + 
  labs(x = paste0('PC1 ',eigenvalues_pca_elas_exp[1],'%'), y = paste0('PC2 ',eigenvalues_pca_elas_exp[2],'%'), color = "Bayside") +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14) #
  ) +
  scale_color_manual(values = c("coral","cornflowerblue"))
pca_elas_exp_bayside_plot


pca_mifish_exp_habitat_plot <- ggplot(pca_lograt_mifish_exp_df, aes(x = PC1, y = PC2, fill = Habitat)) +
  geom_point(size = 3, shape = 21, stroke = 0.5, color = "black") + 
  labs(x = paste0('PC1 ',eigenvalues_pca_mifish_exp[1],'%'), y = paste0('PC2 ',eigenvalues_pca_mifish_exp[2],'%'), color = "Habitat") +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14) #
  ) +
  scale_fill_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey"))
pca_mifish_exp_habitat_plot


pca_elas_exp_habitat_plot <- ggplot(pca_lograt_elas_exp_df, aes(x = PC1, y = PC2, fill = Habitat)) +
  geom_point(size = 3, shape = 21, stroke = 0.5, color = "black") + 
  labs(x = paste0('PC1 ',eigenvalues_pca_elas_exp[1],'%'), y = paste0('PC2 ',eigenvalues_pca_elas_exp[2],'%'), color = "Habitat") +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14) #
  ) +
  scale_fill_manual(values = c("azure2", "chartreuse4", "cadetblue1"))
pca_elas_exp_habitat_plot



pca_mifish_exp_nightday_plot <- ggplot(pca_lograt_mifish_exp_df, aes(x = PC1, y = PC2, fill = Night__Day)) +
  geom_point(size = 3, shape = 21, stroke = 0.5, color = "black") + 
  labs(
    x = paste0('PC1 ', eigenvalues_pca_mifish_exp[1], '%'), 
    y = paste0('PC2 ', eigenvalues_pca_mifish_exp[2], '%'), 
    fill = ""
  ) +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("cornsilk", "antiquewhite4"))
pca_mifish_exp_nightday_plot

pca_elas_exp_nightday_plot <- ggplot(pca_lograt_elas_exp_df, aes(x = PC1, y = PC2, fill = Night__Day)) +
  geom_point(size = 3, shape = 21, stroke = 0.5, color = "black") + 
  labs(
    x = paste0('PC1 ', eigenvalues_pca_elas_exp[1], '%'), 
    y = paste0('PC2 ', eigenvalues_pca_elas_exp[2], '%'), 
    fill = ""
  ) +  
  theme_minimal() + 
  theme(
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12),   
    legend.text = element_text(size = 12), 
    legend.title = element_text(size = 14)
  ) +
  scale_fill_manual(values = c("cornsilk", "antiquewhite4"))
pca_elas_exp_nightday_plot

```

### Env Fit
#### MiFish
```{r}
# sort metadata in same order as the pca matrix
metadata_mifish_exp <- sample_data(ps2024_exp_mifish) %>% data.frame() %>% 
  rownames_to_column(var = "SampleID") %>% arrange(factor(SampleID, levels = rownames(lograt_pca_mifish_exp$x)))

# Fix time and date so it can be used as input

metadata_mifish_exp$DateTime <- as.POSIXct(force_tz((mdy_hms(paste(metadata_mifish_exp$Date, metadata_mifish_exp$Start_Time__ET_))), tzone = "America/New_York"))

# Convert Start Time (from RocSI filtration time) to continuous variable rather than factor. This will be a "time-of-day" variable
metadata_mifish_exp$Time_numeric <- as.numeric(as_hms(as.character(metadata_mifish_exp$Start_Time__ET_)))

# Convert Datecode to numeric
metadata_mifish_exp$Datecode <- as.numeric(metadata_mifish_exp$Datecode)

# Remove some columns of metadate- only retain the env data that I am testing. Leave out the repetitive ID columns, etc.
metadata_mifish_exp <- select(metadata_mifish_exp, -"Name.Deploy_Cartr_Library", -Deployment, -Cartridge_ID, -sites, -replicates, -site_altname, -controls, -Date, -Year, -Month, -Day, -Name.Deploy_Cartr, -Start_Time__ET_, -End_Time__ET_)

# fit environmental factors and save stats output
pca_envfit_mifish_exp <- envfit(lograt_pca_mifish_exp, metadata_mifish_exp, permutations = 10000, na.rm = TRUE)

pca_envfit_mifish_exp
capture.output(pca_envfit_mifish_exp, file = "figures-expedition/pca_envfit_mifish_exp.txt")

```
*SUMMARY- MiFish EnvFir Results that were sig*
Numeric:
                         PC1      PC2     r2   Pr(>r)   
lat                  0.37267  0.92796 0.1441 0.00150 **
Datecode            -0.93766  0.34756 0.0918 0.01900 * 
Avg_Salinity_psu    -0.69632 -0.71773 0.0538 0.09549 . 
Avg_Turbidity_NTU    0.84728 -0.53114 0.0552 0.08269 . 


Categorical variables that are signficant:
               r2  Pr(>r)  
Bayside    0.0413 0.02820 *
Night__Day 0.0326 0.05789 .


#### Elas02
```{r}
# sort metadata in same order as the pca matrix
metadata_elas_exp <- sample_data(ps2024_exp_elas) %>% data.frame() %>% 
  rownames_to_column(var = "SampleID") %>% arrange(factor(SampleID, levels = rownames(lograt_pca_elas_exp$x)))

# Fix time and date so it can be used as input
metadata_elas_exp$DateTime <- as.POSIXct(force_tz((mdy_hms(paste(metadata_elas_exp$Date, metadata_elas_exp$Start_Time__ET_))), tzone = "America/New_York"))

# Convert Start Time (from RocSI filtration time) to continuous variable rather than factor. This will be a "time-of-day" variable
metadata_elas_exp$Time_numeric <- as.numeric(as_hms(as.character(metadata_elas_exp$Start_Time__ET_)))

# Convert Datecode to numeric
metadata_elas_exp$Datecode <- as.numeric(metadata_elas_exp$Datecode)

# Remove some columns of metadata- only retain the env data that I am testing. Leave out the repetitive ID columns, etc.
metadata_elas_exp <- select(metadata_elas_exp, -Deployment, -Cartridge_ID, -sites, -replicates, -controls, -Date, -Year, -Month, -Day, -Name_Deploy_Cartr_Library, -Start_Time__ET_, -End_Time__ET_)

# fit environmental factors and save stats output
pca_envfit_elas_exp <- envfit(lograt_pca_elas_exp, metadata_elas_exp, permutations = 10000, na.rm = TRUE)

pca_envfit_elas_exp
capture.output(pca_envfit_elas_exp, file = "figures-expedition/pca_envfit_elas_exp.txt")

```

*Summary of Envfit to Elas02 library*
Vectors-
                         PC1      PC2     r2    Pr(>r)    
lat                  0.90589 -0.42352 0.3855 9.999e-05 ***
long                 0.94451 -0.32848 0.2780    0.0002 ***

Categorical variables-
                         r2    Pr(>r)    
Bayside              0.2379 9.999e-05 ***
Site_type            0.0830   0.05379 .  


#### Plot EnvFit - Categorical Vars
```{r}
pca_mifish_exp_bayside_plot <- pca_mifish_exp_bayside_plot +
  stat_ellipse(aes(color = factor(Bayside)), level = 0.99)

pca_elas_exp_bayside_plot <- pca_elas_exp_bayside_plot +
  stat_ellipse(aes(color = factor(Bayside)), level = 0.99)

pca_mifish_exp_habitat_plot <- pca_mifish_exp_habitat_plot +
  stat_ellipse(aes(color = factor(Habitat)), level = 0.99) +
  scale_color_manual(values = c("azure2", "chartreuse4", "cadetblue1", "darkgrey")) 


pca_elas_exp_habitat_plot <- pca_elas_exp_habitat_plot +
  stat_ellipse(aes(color = factor(Habitat)), level = 0.99) +
    scale_color_manual(values = c("azure2", "chartreuse4", "cadetblue1")) 


pca_mifish_exp_nightday_plot <- pca_mifish_exp_nightday_plot +
  stat_ellipse(aes(color = factor(Night__Day)), level = 0.99) +
  scale_color_manual(values = c("cornsilk", "antiquewhite4")) +
  guides(color = "none") 



pca_elas_exp_nightday_plot <- pca_elas_exp_nightday_plot +
  stat_ellipse(aes(color = factor(Night__Day)), level = 0.99) +
  scale_color_manual(values = c("cornsilk", "antiquewhite4")) +
  guides(color = "none") 


pca_mifish_exp_bayside_plot
pca_elas_exp_bayside_plot
pca_mifish_exp_habitat_plot
pca_elas_exp_habitat_plot
pca_mifish_exp_nightday_plot
pca_elas_exp_nightday_plot

```

##### Mifish
Add sig vectors from envfit ontop of categ vars
```{r}
pca_mifish_sig_vectors <- as.data.frame(pca_envfit_mifish_exp$vectors$arrows) %>%
  rownames_to_column(var = "EnvVar") %>%
  filter(EnvVar %in% c("lat","Datecode", "Avg_Salinity_psu", "Avg_Turbidity_NTU"))  %>%  
  mutate(EnvVar = ifelse(EnvVar == "Avg_Salinity_psu", "Salinity", EnvVar)) %>%
  mutate(EnvVar = ifelse(EnvVar == "Avg_Turbidity_NTU", "Turbidity", EnvVar)) %>%
  mutate(EnvVar = ifelse(EnvVar == "Datecode", "Date", EnvVar))

# Plot vectors ontop of ellipse plot of bayside
pca_mifish_exp_bayside_date_salinity_plot <- pca_mifish_exp_bayside_plot +
  geom_segment(data = pca_mifish_sig_vectors,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               arrow = arrow(type = "closed", length = unit(0.2, "inches")),
               color = "black") +  
  geom_text(data = pca_mifish_sig_vectors,
            aes(x = PC1, y = PC2, label = EnvVar),
            size = 4, color = "black", vjust = -0.5)

pca_mifish_exp_bayside_date_salinity_plot


```
save
```{r}
ggsave(plot = pca_mifish_exp_bayside_date_salinity_plot, filename = "figures-expedition/pca_mifish_exp_bayside_latlong_date_salinity_turbid_plot.jpg", width = 7, height = 5, units = "in")

ggsave(plot = pca_mifish_exp_nightday_plot, filename = "figures-expedition/pca_mifish_exp_nightday_plot.jpg", width = 7, height = 5, units = "in")

```

##### Elas02
Add sig vectors from envfit ontop of categorical vars (both bayside and habitat significant in this case)
```{r}
pca_elas_sig_vectors <- as.data.frame(pca_envfit_elas_exp$vectors$arrows) %>%
  rownames_to_column(var = "EnvVar") %>%
  filter(EnvVar %in% c("lat", "long"))
    
# Plot vectors ontop of ellipse plot or Bayside
pca_elas_exp_bayside_latlong <- pca_elas_exp_bayside_plot +
  geom_segment(data = pca_elas_sig_vectors,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               arrow = arrow(type = "closed", length = unit(0.2, "inches")),
               color = "black") +  
  geom_text(data = pca_elas_sig_vectors,
            aes(x = PC1, y = PC2, label = EnvVar),
            size = 4, color = "black", vjust = -0.5)
pca_elas_exp_bayside_latlong




```

save
```{r}
ggsave(plot = pca_elas_exp_bayside_latlong, filename = "figures-expedition/pca_elas_exp_bayside_latlong.jpg", width = 7, height = 5, units = "in")

ggsave(plot = pca_elas_exp_habitat_plot, filename = "figures-expedition/pca_elas_exp_habitat_plot.jpg", width = 7, height = 5, units = "in")

```



# Station time series- CONTINUE HERE

## Station 20
follow composition (by bar?) and richness across all samples. annotate important events (day night, rain event, temp)

## Station 15
same



## CONTINUE EDITING above 
Things to do
- Follow most commonly sampled station (15? 20?)- diversity/ composition change through all 2 weeks, comparing day/night especially
- Day night comparison: present in a way which removes samples that were only sampled in the day
- Present analysis of impact of RNAlater preservation (in 2024 trawl MiFish samples)
- Multivariate anlayses: determine if there is influence of time of day, location, etc. 
- Separate flounder figure?
- Make pie charts for bayside?
- Presnet mifish and elasmos together?




